var buy_step_swiper,subtotal,ori_freight,low_con,disfreight,freight,total,ShippingForms,PaymentForms,OrdererForms,RecipientForms,InvoiceForms,$Orderer_TWzipcode,$Recipient_TWzipcode,$Invoice_TWzipcode,$orderer_name,$orderer_sex,$orderer_email,$orderer_cellphone,$orderer_telphone_area,$orderer_telphone,$orderer_telphone_ext,$orderer_address_city,$orderer_address_town,$orderer_address,$recipient_name,$recipient_sex,$recipient_email,$recipient_cellphone,$recipient_telphone_area,$recipient_telphone,$recipient_telphone_ext,$recipient_address_city,$recipient_address_town,$recipient_address,$remark,$invoice_recipient,$invoice_title,$invoice_uniformid,$invoice_address_city,$invoice_address_town,$invoice_address,$ship_method,$pay_method,RecipientsList_dxData,gotop_switch=!1,isCheckout=!1,shipping=null,payment=null,OrdererOpen=!1,RecipientOpen=!1,InvoiceOpen=!1,shipMethodsChosen=!1,payMethodsChosen=!1,OrdererFilled=!0,RecipientFilled=!0,InvoiceFilled=!0,order_header_data={},user_data={},order_data={},recipient_data={},invoice_data={},prod_data={},shopping_cart_data=[],hasProds=!1,islogin=!1;function PageReady(){Coker.Order={AddHeader:function(e){return $.ajax({url:"/api/Order/AddHeader",type:"POST",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:JSON.stringify(e),dataType:"json"})},FrontUserUpdate:function(e){return $.ajax({url:"/api/Order/FrontUserUpdate",type:"POST",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:JSON.stringify(e),dataType:"json"})},GetHeader:function(e){return $.ajax({url:"/api/Order/GetHeaderOne/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{id:e}})},GetDetails:function(e){return $.ajax({url:"/api/Order/GetOrderDetails/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{id:e}})},GetAllData:function(e,t){return $.ajax({url:"/api/Order/GetOrderDisplay",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{ohid:e,check:t}})},GetReorder:function(e){return $.ajax({url:"/api/Order/ReorderDisplay",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{ohid:e}})},GetPaymentTypeEnum:function(){return $.ajax({url:"/api/Order/GetPaymentTypeEnum",type:"POST"})},CheckStock:function(e){return $.ajax({url:"/api/Order/CheckStock",type:"POST",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:JSON.stringify(e),dataType:"json"})},Reorder:function(e){return $.ajax({url:"/api/Order/Reorder/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{ohid:e}})}},Coker.Payment={GetPaymentInfo:function(e){return $.ajax({url:"/api/ShoppingCart/GetPaymentInfo/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{paytypeid:e}})}},$("#btn_car_dropdown").addClass("d-none"),(buy_step_swiper=new Swiper("#BuyStepSwiper > .swiper",{a11y:!0,slidesPerView:1,spaceBetween:15,autoHeight:!0,loop:!1,enabled:!1,pagination:{el:".swiper_pagination > .swiper_pagination_buystep",clickable:!0,renderBullet:function(e,t){return`<span class="${t}">${e+1}</span>`}},navigation:{nextEl:".btn_swiper_next_buystep",prevEl:".btn_swiper_prev_buystep"}})).on("slideChangeTransitionEnd",(function(){gotop_switch&&window.scrollTo(0,$(".swiper").offset().top-$("header").height())})),buy_step_swiper.on("slideChange",(function(){switch(buy_step_swiper.activeIndex){case 1:hasProds||(Coker.sweet.error("錯誤","無可購買商品。",null,!1),buy_step_swiper.slideTo(0));break;case 2:RadioPayment(),ShippingForms.find(".noshipping").length>0?(Coker.sweet.error("錯誤","店家尚未設置運費方式，無法繼續",null,!1),buy_step_swiper.slideTo(1)):PaymentForms.find(".nopayment").length>0?(Coker.sweet.error("錯誤","店家尚未設置付款方式，無法繼續",null,!1),buy_step_swiper.slideTo(1)):(shipMethodsChosen=FormCheck(ShippingForms),payMethodsChosen=FormCheck(PaymentForms),shipMethodsChosen&&payMethodsChosen?(OrdererFilled=FormCheck(OrdererForms),RecipientFilled=FormCheck(RecipientForms),InvoiceFilled=FormCheck(InvoiceForms),OrdererFilled||(OrdererOpen&&$("#OrdererForm>form").removeClass("was-validated"),OrdererEdit(!0),$("#radio_recipient_order").trigger("change"),$("#radio_bill_orderer").trigger("change"))):(Coker.sweet.error("請確實選擇運送及付款方式！",null,!0),setTimeout((function(){buy_step_swiper.slideTo(1)}),1500)));break;case 3:isCheckout||(OrdererOpen&&(OrdererFilled=FormCheck(OrdererForms)),RecipientOpen&&(RecipientFilled=FormCheck(RecipientForms)),InvoiceOpen&&(InvoiceFilled=FormCheck(InvoiceForms)),Coker.sweet.error("未完成結帳流程！","若資料已確實填寫完畢，請點選下方[確認付款]按鈕進入付款程序",null,!1),setTimeout((function(){buy_step_swiper.slideTo(2)}),1500))}})),$("#CollapsePurchase").on("shown.bs.collapse",(function(){buy_step_swiper.update(),$("body").css("height","auto"),$(window).trigger("resize")})).on("hidden.bs.collapse",(function(){buy_step_swiper.update(),$("body").css("height","auto"),$(window).trigger("resize")})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3),GetOrderPage(),Coker.Token.CheckToken().done((function(e){islogin=e.isLogin,Coker.User.GetUser().done((function(e){if(e.success){var t=!0;user_data.orderer=e.data.name,user_data.ordererSex=e.data.sex,user_data.ordererEmail=e.data.email,null==e.data.cellPhone&&(t=!1),user_data.ordererCellPhone=e.data.cellPhone,null!=e.data.telPhone?(user_data.zone=e.data.telPhone.split("-")[0],user_data.ordererTelephone=e.data.telPhone.split("-")[1],user_data.ext=e.data.telPhone.split("-")[2]):(user_data.zone=null,user_data.ordererTelephone=null,user_data.ext=null),null!=e.data.address?(user_data.county=e.data.address.split(" ")[0],user_data.district=e.data.address.split(" ")[1],user_data.ordererAddress=e.data.address.split(" ")[2]):(t=!1,user_data.county=null,user_data.district=null,user_data.ordererAddress=null),user_data.address=e.data.address,t||(OrdererEdit(!0),$("#MemberUpdate").prop("checked",!0)),co.Form.insertData(user_data,"#Form_Orderer"),(order_data=user_data).ordererAddress=user_data.address,ShoppingCartDataInsert(order_data,$("#OrdererForm .default_data")),RecipientSameOrderer(),co.Zipcode.setData({el:$("#Orderer_TWzipcode"),addr:order_data.ordererAddress})}else user_data=null}))})),ElementInit(),$(".btn_call_login").on("click",(function(e){loginModal.show()})),top_position=$(".swiper").offset().top,$(window).scroll((function(){var e=$(".swiper").offset().top-$("header").height();gotop_switch=document.body.scrollTop>e||document.documentElement.scrollTop>e})),document.addEventListener("keyup",AutoSwapInput),$("input,label,button").mousedown((function(e){buy_step_swiper.allowTouchMove=!1})),$("input,label,button").mouseup((function(e){buy_step_swiper.allowTouchMove=!0})),ShippingForms=$("#RadioShipping"),PaymentForms=$("#RadioPayment"),$(".btn_swiper_next_step3").on("click",Step2Monitor),OrdererForms=$("#OrdererForm > form"),RecipientForms=$("#RecipientForm > form"),InvoiceForms=$("#InvoiceForm > form"),$(".btn_checkout").on("click",Step3Monitor),$(".btn_back_to_check").on("click",(function(){buy_step_swiper.slideTo(0)})),$(".btn_goprev").on("click",(function(){buy_step_swiper.slidePrev()})),$(".btn_edit_data").on("click",(function(){OrdererEdit(null)})),$(".btn_delete_recipient").on("click",DeleteRecipient),$("input[type=radio][name=RadioShipping]").on("change",RadioShipping),$("input[type=radio][name=RadioPayment]").on("change",RadioPayment),$("input[type=radio][name=RecipientRadio]").on("change",RecipientRadio),$("input[type=radio][name=InvoiceRadio]").on("change",InvoiceRadio),$(".btn_backshop").each((function(){var e=$(this);""==e.attr("href")&&e.attr("title","繼續購物：返回上一頁")})),$(".btn_backshop").on("click",(function(e){if(""==$(this).attr("href"))return history.back(),!1})),$(".btn_inituser").on("click",(function(){var e=$("#MemberUpdate").prop("checked");if(co.Form.clear("Form_Orderer"),$("#MemberUpdate").prop("checked",e),null==user_data)$('#Form_Orderer .gender input[type="radio"]').prop("checked",!1),co.Zipcode.setData({el:$("#Orderer_TWzipcode"),addr:"縣市"});else{$('#Form_Orderer .gender input[type="radio"]').prop("checked",!1);var t=user_data.ordererAddress;t&&t.indexOf(" ")>0&&(t.split(" ").length>=3?user_data.ordererAddress=t.split(" ")[2]:user_data.ordererAddress=""),co.Form.insertData(user_data,"#Form_Orderer"),user_data.ordererAddress=t,co.Zipcode.setData({el:$("#Orderer_TWzipcode"),addr:user_data.address})}}))}function hashChange(e){e?(e.preventDefault(),GetOrderPage()):console.log("HashChange錯誤")}function GetOrderPage(){if($.isNumeric(window.location.search.substring(1))){isCheckout=!0;var e=parseInt(window.location.search.substring(1));Coker.Order.GetAllData(e,!0).done((function(e){if(e.length>0){var t=e[0];switch($("#Step4 > .card-header > .order_number").text(window.location.search.substring(1)),$("#Step4 > .card-body .pruchase_content .order_time").text(`訂單成立時間：${t.orderHeader.creationTime}`),t.orderHeader.stateStr){case"待確認":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，謝謝您的訂購！");break;case"已付款":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立並完成付款，謝謝您的訂購！");break;case"已取消":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已取消。");break;case"付款失敗":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單付款失敗！"),$(".buyagain_text").length>0&&($(".buyagain_text").removeClass("d-none"),$(".buyagain_text span").on("click",(function(){var e=parseInt($("#Step4 .card-header .order_number").text());Coker.Order.Reorder(e).done((function(e){if(e.success){var t=`000000000${e.message}`.substring(e.message.length);window.location.href=`/${OrgName}/ShoppingCar?reorder${t}`}else Coker.sweet.error("錯誤",e.message)}))})));break;case"待付款":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，待商家確認付款資訊，謝謝您的訂購！")}SuccessPageDataInsert(t)}else islogin?$("#Step4 > .card-body > .pruchase_content > .status_alert").text("查無訂單資訊或期限已過，請至會員管理歷史訂單中確認"):$("#Step4 > .card-body > .pruchase_content > .status_alert").text("查無訂單資訊");buy_step_swiper.enable(),buy_step_swiper.slideTo(4),buy_step_swiper.disable()}))}else if(window.location.search.substring(1).startsWith("reorder")){e=parseInt(window.location.search.substring("reorder".length+1));Coker.Order.GetReorder(e).done((function(e){e.success&&null!=e.orderHeader&&null!=e.orderDetails?($("#Step1 > .card-body").removeClass("d-none"),buy_step_swiper.enable(),$("#Purchase_Null").addClass("d-none"),CartInit(e.orderDetails)):window.location.href=`/${OrgName}/ShoppingCar`}))}}function SuccessPageDataInsert(e){var t=e.orderHeader,r=e.orderDetails;ShoppingCartDataInsert(t,$("#Step4 .card-body")),TemplateDataInsert($("#Purchase"),$("#CollapsePurchase"),$("#Template_Purchase_Details"),r)}function ElementInit(){$Orderer_TWzipcode=$("#Orderer_TWzipcode"),$Recipient_TWzipcode=$("#Recipient_TWzipcode"),$Invoice_TWzipcode=$("#Invoice_TWzipcode"),TWZipCodeInit(),$orderer_name=$("#OrdererInputName"),$orderer_sex=$("input[name=OrdererRadioGender]"),$orderer_email=$("#OrdererInputMail"),$orderer_cellphone=$("#OrdererInputCellPhone"),$orderer_telphone_area=$("#OrdererInputTelPhoneArea"),$orderer_telphone=$("#OrdererInputTelPhone"),$orderer_telphone_ext=$("#OrdererInputTelPhoneExt"),$orderer_address_city=$Orderer_TWzipcode.children(".county").children("select"),$orderer_address_town=$Orderer_TWzipcode.children(".district").children("select"),$orderer_address=$("#OrdererInputAddress"),$recipient_radio=$("input[name=RecipientRadio]"),$recipient_name=$("#RecipientInputName"),$recipient_sex=$("input[name=RecipientRadioGender]"),$recipient_email=$("#RecipientInputMail"),$recipient_cellphone=$("#RecipientInputCellPhone"),$recipient_telphone_area=$("#RecipientInputTelPhoneArea"),$recipient_telphone=$("#RecipientInputTelPhone"),$recipient_telphone_ext=$("#RecipientInputTelPhoneExt"),$recipient_address_city=$Recipient_TWzipcode.children(".county").children("select"),$recipient_address_town=$Recipient_TWzipcode.children(".district").children("select"),$recipient_address=$("#RecipientInputAddress"),$remark=$("#TextareaRemark"),$invoice_recipient=$("input[name=InvoiceRadio]"),$invoice_title=$("#InvoiceInputTitle"),$invoice_uniformid=$("#InvoiceInputUniformId"),$invoice_address_city=$Invoice_TWzipcode.children(".county").children("select"),$invoice_address_town=$Invoice_TWzipcode.children(".district").children("select"),$invoice_address=$("#InvoiceInputAddress"),($ship_method=$("input[name=RadioShipping]")).each((function(){$(this).is(":checked")?(shipping=$(this).val(),ori_freight=$(this).data("freight"),low_con=$(this).data("lowcon"),disfreight=$(this).data("disfreight"),freight=ori_freight):freight=0})),$pay_method=$("input[name=RadioPayment]")}function CardDataGet(){Product.GetAll.Cart().done((function(e){e.length>0&&CartInit(e)}))}function CartInit(e){$("#Step1 > .card-body").removeClass("d-none");for(var t=0;t<e.length;t++)CartListAdd(e[t]);$("#Purchase_Null").addClass("d-none"),buy_step_swiper.enable();Array.prototype.slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')).map((function(e){return new bootstrap.Popover(e)}));buy_step_swiper.update(),TotalCount(),PaymentForms.children("div").each((function(){var e=$(this),t=e.find("input");if(t.length>0){var r=t.attr("id").replaceAll("radio_payment_","");r.toLowerCase().startsWith("pchome")&&(r.startsWith("PchomePayInstallment")?(r="CARD",e.attr("data-paycode",r)):r.startsWith("PchomePay")?(r=r.replaceAll("PchomePay",""),e.attr("data-paycode",r)):r.startsWith("PCHome")&&(r=r.replaceAll("PCHome",""),e.attr("data-paycode",r)))}})),PaymentHideShow()}function PaymentHideShow(){if(PaymentForms.find("div[data-paycode]").removeClass("d-none"),subtotal<1?PaymentForms.find("div[data-paycode]").addClass("d-none"):(subtotal<65&&PaymentForms.find("div[data-paycode^='IP']").addClass("d-none"),subtotal<30&&PaymentForms.find("div[data-paycode='CARD']").addClass("d-none"),subtotal<25&&PaymentForms.find("div[data-paycode]").addClass("d-none")),subtotal>199999){(e=PaymentForms.find("div[data-paycode]")).length>0&&e.addClass("d-none")}else{var e;if(subtotal>2e4)(e=PaymentForms.find("div[data-paycode^='IP'], div[data-paycode='IBRCD']")).length>0&&e.addClass("d-none");if(subtotal>49999)(e=PaymentForms.find("div[data-paycode='ATM'], div[data-paycode='EACH']")).length>0&&e.addClass("d-none")}}function CartListAdd(e){if(e.quantity>0)if(null!=shopping_cart_data.find((t=>t.Id==e.scId)))e.price=shopping_cart_data.find((t=>t.Id==e.scId)).Price;else{var t={};t.Id=e.scId,t.Price=e.price,t.Quantity=e.quantity,shopping_cart_data.push(t),hasProds=!0}var r=e.quantity+e.stock,a=$("#Step1 > .card-body > .purchase_list"),i=$($("#Template_Cart_Details").html()).clone();if(i.data("scId",e.scId),(i=CartListInsert(i,e)).find(".btn_remove_pro").on("click",(function(){var e=$(this).parents("li").first();Coker.sweet.confirm("確定將商品從購物車移除？","該商品將會從購物車中移除，且不可復原。","確認移除","取消",(function(){CartDelete(e,e.data("scId"),"成功移除商品","移除商品發生未知錯誤")}))})),i.find(".btn_count_plus").on("click",(function(){var t=$(this).siblings(".pro_quantity");t.val()<r&&(t.val(parseInt(t.val())+1),CartQuantityUpdate(i.find(".pro_subtotal"),e.price,i.data("scId"),t.val()))})),i.find(".btn_count_minus").on("click",(function(){var t=$(this).siblings(".pro_quantity");t.val()>1&&(t.val(parseInt(t.val())-1),CartQuantityUpdate(i.find(".pro_subtotal"),e.price,i.data("scId"),t.val()))})),i.find(".pro_quantity").on("change",(function(){var t=$(this);t.val()<1&&t.val(1),t.val()>r&&t.val(r),CartQuantityUpdate(i.find(".pro_subtotal"),e.price,i.data("scId"),t.val())})),i.find(".btn_move_to_favorites").length>0&&islogin){var n=i.find(".btn_move_to_favorites");n.parent("span").removeClass("d-none"),Coker.Favorites.Check(e.pId).done((function(e){e.success&&(n.data("Fid",e.message),n.find("i").addClass("fa-solid"),n.find("i").removeClass("fa-regular"))})),n.on("click",(function(){var t=$(this).find("i");t.hasClass("fa-regular")?Coker.Favorites.Add(e.pId).done((function(e){e.success?(n.data("Fid",e.message),t.addClass("fa-solid"),t.removeClass("fa-regular"),Coker.sweet.success("成功將商品加入收藏",null,!0)):Coker.sweet.error("商品加入收藏發生錯誤",e.message,null,!0)})):void 0!==n.data("Fid")&&""!=typeof n.data("Fid")&&Coker.Favorites.Delete(n.data("Fid")).done((function(e){e.success?(n.data("Fid",""),t.addClass("fa-regular"),t.removeClass("fa-solid"),Coker.sweet.success("已將商品從收藏中移除",null,!0)):Coker.sweet.error("商品移除收藏發生錯誤",e.message,null,!0)}))}))}a.append(i)}function CartListInsert(e,t){return e.find("*").each((function(){var r=$(this);if(void 0!==r.data("key")){var a=r.data("key");switch(a){case"link":r.attr({href:`/${OrgName}/home/product/${t.pId}`,title:`連結至：${t.title}(另開新視窗)`});break;case"spec":r.append(""==t.s1Title?"":`<span class="border px-1 me-1">${t.s1Title}</span>`),r.append(""==t.s2Title?"":`<span class="border px-1 me-1">${t.s2Title}</span>`);break;case"imagePath":t[a]=t[a].replaceAll(`/${OrgName}/`,"/"),r.attr({src:t[a],alt:`${t.title}的圖片`});break;case"oldQuantity":t[a]!=t.quantity&&r.removeClass("d-none"),r.text(t[a]);break;case"oldPrice":t[a]!=t.price&&t[a]>0&&(r.removeClass("d-none"),r.text(t[a]),r.siblings("div[data-key='price']").addClass("red_text"));break;case"subtotal":r.text(t.price*t.quantity),r.data("subtotal",t.price*t.quantity),CartQuantityUpdate(r,t.price,e.data("scId"),t.quantity);break;case"quantity":r.val(t[a]);break;default:r.text(t[a])}if(0==t.quantity&&(e.find(".nostock").removeClass("d-none"),e.find(".content").addClass("d-none"),e.find(".btn_side_icon").addClass("d-none")),"price"===r.data("type"))r.text(parseInt(r.text()).toLocaleString())}})),e}function CartQuantityUpdate(e,t,r,a){a>0&&Product.Update.Cart({Id:r,Quantity:a}).done((function(i){i.success?Product.GetOne.Cart(i.message).done((function(i){shopping_cart_data.find((e=>e.Id==i.scId)).Price=t,shopping_cart_data.find((e=>e.Id==i.scId)).Quantity=a,e.data("subtotal",t*a),e.text((t*a).toLocaleString()),TotalCount(),CartDropReset(r,a)})):"商品庫存不足"==i.error?Coker.sweet.error(i.error,i.message,(function(){location.reload(!0)}),!1):Coker.sweet.error("商品更改數量發生錯誤",i.message,null,!0)})).fail((function(){Coker.sweet.error("錯誤","商品數量修改發生錯誤",null,!0)}))}function TotalCount(){subtotal=0,$(".purchase_list").children("li").each((function(){subtotal+=$(this).children(".content").children(".pro_subtotal").data("subtotal"),freight=subtotal>low_con?disfreight:ori_freight})),$(".subtotal").each((function(){$(this).text(subtotal.toLocaleString())})),$(".shipping_fee").each((function(){$(this).text(null==freight||""==freight||""==freight?0:freight.toLocaleString())})),$(".total_amount").each((function(){total=null==freight||""==freight?subtotal:subtotal+freight,$(this).text(parseInt(total).toLocaleString())})),PaymentHideShow()}function CartDelete(e,t,r,a){e.remove(),Product.Delete.Cart(t).done((function(){Coker.sweet.success(r,null,!0);var e=shopping_cart_data.findIndex((e=>e.Id==t));-1!==e&&shopping_cart_data.splice(e,1),CartDropReset(t,0),TotalCount(),0==parseInt($("#Car_Badge").text())&&DetailsClear()})).fail((function(){Coker.sweet.error("錯誤",a,null,!0)}))}function Step2Monitor(){shipMethodsChosen=FormCheck(ShippingForms),payMethodsChosen=FormCheck(PaymentForms),shipMethodsChosen&&payMethodsChosen?buy_step_swiper.slideNext():Coker.sweet.error("請確實選擇運送及付款方式！",null,!0),buy_step_swiper.update()}function RadioShipping(){ori_freight=$(this).data("freight"),low_con=$(this).data("lowcon"),disfreight=$(this).data("disfreight"),freight=ori_freight,TotalCount()}function RadioPayment(){var e=$(".payment_method");e.addClass("fs-2 fw-bold px-3"),$pay_method.each((function(){var t=$(this);t.is(":checked")&&(1==t.val()?$(".pay_info").removeClass("d-none"):$(".pay_info").addClass("d-none"),e.text(t.siblings("label").text()))})),buy_step_swiper.update()}function Step3Monitor(){if(OrdererFilled=FormCheck(OrdererForms),RecipientOpen)RecipientFilled=FormCheck(RecipientForms);else if("order"===$('[name="RecipientRadio"]:checked').val())RecipientSameOrderer(),RecipientFilled=!0;if(InvoiceOpen)InvoiceFilled=FormCheck(InvoiceForms);else switch($('[name="InvoiceRadio"]:checked').val()){case"order":case"recipient":InvoiceFilled=!0}OrdererFilled?RecipientFilled?InvoiceFilled?Coker.sweet.confirm("是否確定結帳？","點選確認進入付款流程","是，開始付款","否",(function(){OrderHeaderAdd()})):Coker.sweet.error("請確實填寫發票寄送資料！",null,!0):Coker.sweet.error("請確實填寫收件人資料！",null,!0):(OrdererOpen||OrdererEdit(!0),Coker.sweet.error("請確實填寫訂購人資料！",null,!0)),buy_step_swiper.update()}function OrdererEdit(e){if(null==e&&OrdererEdit(e=!OrdererOpen),!OrdererOpen&&e)$("#OrdererForm > .default_data").addClass("d-none"),$("#OrdererForm > form").removeClass("d-none"),OrdererOpen=!0,OrdererFilled=!1;else if(OrdererOpen&&!e){var t=co.Form.getJson($("#Form_Orderer").attr("id"),$("#OrdererForm .default_data"));t.ordererAddress=`${t.county}${t.district}${t.ordererAddress}`,ShoppingCartDataInsert(t,$("#OrdererForm .default_data")),$("#OrdererForm > .default_data").removeClass("d-none"),$("#OrdererForm > form").addClass("d-none"),OrdererOpen=!1,OrdererFilled=!0}buy_step_swiper.update()}function RecipientRadio(){var e=$(this);recipient_data={},"edit"==e.val()?($("#RecipientForm > .default_data").addClass("d-none"),$("#RecipientForm > form").removeClass("d-none"),RecipientOpen=!0,RecipientFilled=!1,RecipientFormClear()):"order"==e.val()?($("#RecipientForm > .default_data").addClass("d-none"),$("#RecipientForm > form").addClass("d-none"),RecipientOpen=!1,RecipientFilled=!0,RecipientSameOrderer()):($("#RecipientForm > .default_data").addClass("d-none"),$("#RecipientForm > form").addClass("d-none"),RecipientOpen=!1,RecipientFilled=!0),buy_step_swiper.update()}function RecipientFormClear(){$recipient_name.val(""),$recipient_sex.val(""),$recipient_sex.each((function(){$(this).removeAttr("checked")})),$recipient_email.val(""),$recipient_cellphone.val(""),$recipient_telphone_area.val(""),$recipient_telphone.val(""),$recipient_telphone_ext.val(""),$recipient_address_city.val(""),$recipient_address_town.val(""),$recipient_address.val(""),$remark.val("")}function RecipientSameOrderer(){for(var e in order_data)e.startsWith("orderer")>0&&(recipient_data[e.replace("orderer","recipient")]=order_data[e])}function InvoiceRadio(){switch(invoice_data={},this.value){case"order":case"recipient":$("#InvoiceForm > .default_data").addClass("d-none"),$("#InvoiceForm > form").addClass("d-none"),InvoiceOpen=!1,InvoiceFilled=!0;break;case"company":$("#InvoiceForm > .default_data").addClass("d-none"),$("#InvoiceForm > form").removeClass("d-none"),InvoiceOpen=!0,InvoiceFilled=!1,InvoiceFormClear()}buy_step_swiper.update()}function InvoiceFormClear(){$invoice_title.val(""),$invoice_uniformid.val(""),$invoice_address_city.val(""),$invoice_address_town.val(""),$invoice_address.val("")}function InvoiceFormSet(e,t,r,a,i){$invoice_title.val(e),$invoice_uniformid.val(t),$Invoice_TWzipcode.twzipcode("set",{county:r,district:a}),$invoice_address.val(i)}function FormCheck(e){var t=!1;return Array.from(e).forEach((e=>{e.checkValidity()&&(t=!0),e.classList.add("was-validated")})),t}function DetailsClear(){$("#Step1 > .card-body").addClass("d-none"),$("#Purchase_Null").removeClass("d-none"),buy_step_swiper.disable()}function DeleteRecipient(){$(this).parents("tr").remove()}function OrderHeaderAdd(){Coker.Order.CheckStock(shopping_cart_data).done((function(e){if(e.success){var t=!0;for(var r in(order_data=co.Form.getJson($("#Form_Orderer").attr("id"))).ordererAddress=`${order_data.county} ${order_data.district} ${order_data.ordererAddress}`,""==order_data.zone^""==order_data.ordererTelephone?(Coker.sweet.error("資料填寫錯誤","如要提供訂購人電話資訊，請確實填寫區碼與聯絡電話。",null,!1),t=!1):""==order_data.zone&&""==order_data.ordererTelephone?order_data.ordererTelephone=null:order_data.ordererTelephone=`${order_data.zone}-${order_data.ordererTelephone}`+(""==order_data.ext?"":`-${order_data.ext}`),order_data)r.startsWith("orderer")>0&&(order_header_data[r]=order_data[r]);switch($('[name="RecipientRadio"]:checked').val()){case"order":RecipientSameOrderer();break;case"edit":(recipient_data=co.Form.getJson($("#Form_Recipient").attr("id"))).recipientAddress=`${recipient_data.county} ${recipient_data.district} ${recipient_data.recipientAddress}`,""==recipient_data.zone^""==recipient_data.recipientTelephone?(Coker.sweet.error("資料填寫錯誤","如要提供收件人電話資訊，請確實填寫區碼與聯絡電話。",null,!1),t=!1):""==recipient_data.zone&&""==recipient_data.recipientTelephone?recipient_data.recipientTelephone=null:recipient_data.recipientTelephone=`${recipient_data.zone}-${recipient_data.recipientTelephone}`+(""==recipient_data.ext?"":`-${recipient_data.ext}`)}for(var r in recipient_data)r.startsWith("recipient")>0&&(order_header_data[r]=recipient_data[r]);switch(void 0===recipient_data.remark||""==recipient_data.remark?order_header_data.remark="無":order_header_data.remark=recipient_data.remark,$('[name="InvoiceRadio"]:checked').val()){case"order":invoice_data.invoiceRecipient=1,invoice_data.invoiceAddress=order_data.ordererAddress;break;case"recipient":invoice_data.invoiceRecipient=2,invoice_data.invoiceAddress=recipient_data.recipientAddress;break;case"company":(invoice_data=co.Form.getJson($("#Form_Invoice").attr("id"))).invoiceAddress=`${invoice_data.county} ${invoice_data.district} ${invoice_data.invoiceAddress}`,invoice_data.invoiceRecipient=3,order_header_data.uniformId=invoice_data.uniformId}for(var r in invoice_data)r.startsWith("invoice")>0&&(order_header_data[r]=invoice_data[r]);if(order_header_data.shipping=$('[name="RadioShipping"]:checked').val(),order_header_data.payment=$('[name="RadioPayment"]:checked').val(),order_header_data.state=1,order_header_data.subtotal=subtotal,order_header_data.discount=0,order_header_data.bonus=0,order_header_data.couponId=0,order_header_data.freight=""==freight?0:freight,order_header_data.Service_Charge=0,order_header_data.OrderDetails=shopping_cart_data,t){var a="";$(".memberUpdate").length>0&&$("#MemberUpdate").is(":checked")&&Coker.Order.FrontUserUpdate(order_header_data).done((function(e){e.success||(a=`<br/>${e.message}`)})),Coker.sweet.loading(),Coker.Order.AddHeader(order_header_data).done((function(e){e.success?Coker.sweet.success(`謝謝您的訂購！${a}<br />訂單處理中，若有錯誤請修正後重送訂單。請勿按[回上頁]按鈕，以免重複下單，或發生其他不可預期的錯誤！`,(function(){OrderSuccess(e),setTimeout((function(){isCheckout=!0;var t=e.message.split(",")[0];switch(t){case"LinePay":case"PCHomePay":Coker.sweet.loading(),Coker.ThirdParty.Request(e.message.split(",")[1],t).done((function(e){Swal.close(),e.success?(localStorage.setItem("lastSaveTime",(new Date).toISOString()),localStorage.setItem("lastSaveToken",localStorage.getItem("token")),$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，即將進入付款流程。"),setTimeout((function(){buy_step_swiper.slideNext(),buy_step_swiper.disable()}),300),window.open(e.message,"_blank")):($("#Step4 > .card-body > .pruchase_content > .status_alert").text("付款流程發生未知錯誤，請稍後重新嘗試，或直接聯繫客服人員。"),setTimeout((function(){buy_step_swiper.slideNext(),buy_step_swiper.disable()}),300))}));break;case"Default":setTimeout((function(){buy_step_swiper.slideNext(),buy_step_swiper.disable()}),300)}}),300)})):(console.log(e),Coker.sweet.error("錯誤","訂購商品發生未知錯誤",null,!0))})).fail((function(e){console.log(e),Coker.sweet.error("錯誤","訂購商品發生未知錯誤",null,!0)}))}}else Coker.sweet.error("錯誤",e.message,null,!1),$("#Step1 > .card-body > .purchase_list > li").remove(),CardDataGet(),buy_step_swiper.slideTo(0)}))}function OrderSuccess(e){var t=e.message.split(","),r=t[1];switch(CartClear(),$("#Step4 > .card-header > .order_number").text(("000000000"+r).substring(r.length)),$("#Step4 > .card-body .pruchase_content .order_time").text(`訂單成立時間：${t[4]}`),$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，謝謝您的訂購！"),""!=$(".storememo").text()?Swal.fire({title:"小提醒",icon:"info",html:$(".storememo").text().replaceAll("\n","<br/>"),focusConfirm:!1,confirmButtonText:"確認"}).then((t=>{null!=e.error&&(islogin?Coker.sweet.error("信件發送失敗","訂購信件發送失敗，訂單詳細可於會員管理歷史訂單中查看。"):Coker.sweet.error("信件發送失敗","訂購信件發送失敗，請註冊會員以查看詳細訂單，或將訂單完成頁面截圖。"))})):null!=e.error&&(islogin?Coker.sweet.error("信件發送失敗","訂購信件發送失敗，訂單詳細可於會員管理歷史訂單中查看。"):Coker.sweet.error("信件發送失敗","訂購信件發送失敗，請註冊會員以查看詳細訂單，或將訂單完成頁面截圖。")),$(".storememo").empty(),ShoppingCartDataInsert(order_data,$("#Step4 .orderer_data")),ShoppingCartDataInsert(recipient_data,$("#Step4 .recipient_data")),invoice_data.invoiceRecipient){case 1:ShoppingCartDataInsert(order_data,$("#Step4 .invoice_data .orderer")),$("#Step4 .invoice_data .orderer").removeClass("d-none");break;case 2:ShoppingCartDataInsert(recipient_data,$("#Step4 .invoice_data .recipient")),$("#Step4 .invoice_data .recipient").removeClass("d-none");break;case 3:ShoppingCartDataInsert(invoice_data,$("#Step4 .invoice_data .company")),$("#Step4 .invoice_data .company").removeClass("d-none")}$("#PaymentData .pay_info .paid_date").append(`${t[2]}<span>${t[3]}23點59分</span>`);var a=order_header_data.ordererEmail;$("#PaymentData .pay_mail").append(`如因交易條件有誤、商品缺貨或價格物刊或有其他本公司無法接受訂單之情形,本公司保留商品出貨與否的權利。<br />．隨後我們也會將轉帳的資料mail到您指定的電子信箱:${a.substr(0,1)}******${a.substr(a.indexOf("@")-1)}`),Coker.Order.GetDetails(r).done((function(e){if(e.length>0){e.length>1&&$(".btn_view_list").removeClass("d-none");for(var t=0;t<e.length;t++)PurchaseAdd(e[t],0==t?$("#Step4 > .card-body > .pruchase_content > .purchase_list").first():$("#Step4 > .card-body > .pruchase_content > .purchase_list.collapse"))}})),Coker.Payment.GetPaymentInfo(order_header_data.payment).done((function(e){if(null!=e&&e.length>0){var t="";$.each(e,(function(e,r){t+=`<div class="mb-2 row">\n                                        <div class="col-auto col-sm-2 py-0 text-end">${r.title}：</div>\n                                        <div class="col ps-0">${r.value}</div>\n                                    </div>`})),$(".pay_info > div").prepend(t)}}))}function PurchaseAdd(e,t){var r=$($("#Template_Purchase_Details").html()).clone(),a=r.find(".pro_link"),i=r.find(".pro_image"),n=r.find(".pro_name"),o=r.find(".pro_specification"),d=r.find(".pro_unit"),s=r.find(".pro_quantity"),c=r.find(".pro_subtotal");a.attr("href",`/${OrgName}/Home/product/`+e.pId),a.attr("title",`連結至：${e.title}(另開新視窗)`),i.attr("src",e.imagePath.replace(`upload/${OrgName}/`,"upload/")),n.text(e.title),o.append(""==e.s1Title?"":'<span class="border px-1 me-1">'+e.s1Title+"</span>"),o.append(""==e.s2Title?"":'<span class="border px-1">'+e.s2Title+"</span>"),d.text(`$${e.price.toLocaleString("en-US")}`),s.text(e.quantity),c.text((e.price*e.quantity).toLocaleString("en-US")),t.append(r)}function HiddenCode(e){e.find("*").each((function(){var e=$(this);e.data("key");if(void 0!==e.data("key"))switch(e.data("type")){case"name":var t=e.text();e.text(`${t.substr(0,1)}○${t.substr(t.length-1)}`);break;case"email":var r=e.text();e.text(`${r.substr(0,3)}**********`);break;case"phone":var a=e.text();e.text(`${a.substr(0,3)}****${a.substr(a.length-3)}`);break;case"address":var i=e.text();i=i.split(" ")[0]+i.split(" ")[1]+i.split(" ")[2],e.text(`${i.substr(0,9)}*****`);break;case"uniformId":var n=e.text();e.text(`${n.substr(0,3)}*****`)}}))}function ShoppingCartDataInsert(e,t){if(ShoppingCartDataClear(t),void 0!==e.invoiceRecipient)switch(parseInt(e.invoiceRecipient)){case 1:$(".invoice_data .orderer").removeClass("d-none");break;case 2:$(".invoice_data .recipient").removeClass("d-none");break;case 3:$(".invoice_data .company").removeClass("d-none")}t.find("*").each((function(){var t=$(this),r=t.data("key");void 0!==t.data("key")&&(t.hasClass("price")?t.text(e[r].toLocaleString()):t.text(e[r]))}))}function ShoppingCartDataClear(e){e.find("*").each((function(){var e=$(this);e.data("key");void 0!==e.data("key")&&e.text("")}))}function TemplateDataInsert(e,t,r,a){$.each(a,(function(a,i){var n=$(r.html()).clone();n.find("*").each((function(){var e=$(this),t=e.data("key");if(void 0!==e.data("key"))switch(t){case"link":e.attr({href:`/${OrgName}/Home/product/${i.prodId}`,title:`連結至：${i.title}(另開新視窗)`});break;case"imagePath":i[t]=i[t].replace(`/${OrgName}/`,"/"),e.attr({src:i[t],alt:i.title});break;case"spec":e.append(""==i.s1Title?"":`<span class="border px-1 me-1">${i.s1Title}</span>`),e.append(""==i.s2Title?"":`<span class="border px-1 me-1">${i.s2Title}</span>`);break;default:e.hasClass("price")&&!e.hasClass("pro_unit")?e.text(i[t].toLocaleString()):e.text(i[t])}})),0==a?e.append(n):($(".btn_view_list").removeClass("d-none"),t.append(n))}))}function AutoSwapInput(){var e=event.target;if("INPUT"==e.nodeName&&e.className.indexOf("pro_quantity")<0&&e.value.length==e.maxLength){var t=$(e).parents("form").first().find("input");for(let r=0;r<t.length;r++)if(t[r]==e)return void(t[r+1]&&t[r+1].focus())}}function TWZipCodeInit(){var e,t,r,a;$Orderer_TWzipcode.twzipcode({zipcodeIntoDistrict:!0}),$Recipient_TWzipcode.twzipcode({zipcodeIntoDistrict:!0}),$Invoice_TWzipcode.twzipcode({zipcodeIntoDistrict:!0}),e=$Orderer_TWzipcode.children(".county"),t=$Orderer_TWzipcode.children(".district"),e.children("select").attr({id:"OrdererSelectCity",class:"orderer_city form-select",required:"required"}),e.append("<label class='px-4 required' for='OrdererSelectCity'>縣市</label>"),(r=e.children("select").children("option").first()).text("請選擇縣市"),r.attr("disabled","disabled"),t.children("select").attr({id:"OrdererSelectTown",class:"orderer_town form-select",required:"required"}),t.append("<label class='px-4 required' for='OrdererSelectCity'>鄉鎮</label>"),(a=t.children("select").children("option").first()).text("請選擇鄉鎮"),a.attr("disabled","disabled"),e=$Recipient_TWzipcode.children(".county"),t=$Recipient_TWzipcode.children(".district"),e.children("select").attr({id:"RecipientSelectCity",class:"recipient_city form-select",required:"required"}),e.append("<label class='px-4 required' for='RecipientSelectCity'>縣市</label>"),(r=e.children("select").children("option").first()).text("請選擇縣市"),r.attr("disabled","disabled"),t.children("select").attr({id:"RecipientSelectTown",class:"recipient_town form-select",required:"required"}),t.append("<label class='px-4 required' for='RecipientSelectCity'>鄉鎮</label>"),(a=t.children("select").children("option").first()).text("請選擇鄉鎮"),a.attr("disabled","disabled"),e=$Invoice_TWzipcode.children(".county"),t=$Invoice_TWzipcode.children(".district"),e.children("select").attr({id:"InvoiceSelectCity",class:"bill_city form-select",required:"required"}),e.append("<label class='px-4 required' for='InvoiceSelectCity'>縣市</label>"),(r=e.children("select").children("option").first()).text("請選擇縣市"),r.attr("disabled","disabled"),t.children("select").attr({id:"InvoiceSelectTown",class:"bill_town form-select",required:"required"}),t.append("<label class='px-4 required' for='InvoiceSelectCity'>鄉鎮</label>"),(a=t.children("select").children("option").first()).text("請選擇鄉鎮"),a.attr("disabled","disabled")}function RecipientsList_ContentReady(e){RecipientsList_dxData=$("#RecipientsList").dxDataGrid("instance"),console.log("RecipientsList_dxData",RecipientsList_dxData)}function RecipientsList_SelectChange(e){var t=e.selectedRowsData;console.log("Select",t)}function RecipientsList_DeleteButtonClicked(e){console.log(e.row.key),co.sweet.confirm("刪除收件人","確定刪除？資料刪除後不可復原","確　定","取　消",(function(){}))}