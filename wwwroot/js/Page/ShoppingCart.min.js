var buy_step_swiper,subtotal,ori_freight,low_con,disfreight,freight,total,ShippingForms,PaymentForms,OrdererForms,RecipientForms,InvoiceForms,$Orderer_TWzipcode,$Recipient_TWzipcode,$Invoice_TWzipcode,$orderer_name,$orderer_sex,$orderer_email,$orderer_cellphone,$orderer_telphone_area,$orderer_telphone,$orderer_telphone_ext,$orderer_address_city,$orderer_address_town,$orderer_address,$recipient_name,$recipient_sex,$recipient_email,$recipient_cellphone,$recipient_telphone_area,$recipient_telphone,$recipient_telphone_ext,$recipient_address_city,$recipient_address_town,$recipient_address,$remark,$invoice_recipient,$invoice_title,$invoice_uniformid,$invoice_address_city,$invoice_address_town,$invoice_address,$ship_method,$pay_method,gotop_switch=!1,isCheckout=!1,shipping=null,payment=null,OrdererOpen=!1,RecipientOpen=!1,InvoiceOpen=!1,shipMethodsChosen=!1,payMethodsChosen=!1,OrdererFilled=!0,RecipientFilled=!0,InvoiceFilled=!0,order_header_data={},user_data={},order_data={},recipient_data={},invoice_data={},prod_data={},islogin=!1;function PageReady(){Coker.Order={AddHeader:function(e){return $.ajax({url:"/api/Order/AddHeader",type:"POST",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:JSON.stringify(e),dataType:"json"})},GetHeader:function(e){return $.ajax({url:"/api/Order/GetHeaderOne/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{id:e}})},GetDetails:function(e){return $.ajax({url:"/api/Order/GetOrderDetails/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{id:e}})},GetAllData:function(e,t){return $.ajax({url:"/api/Order/GetOrderDisplay",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{ohid:e,check:t}})},GetReorder:function(e){return $.ajax({url:"/api/Order/ReorderDisplay",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{ohid:e}})},GetPaymentTypeEnum:function(){return $.ajax({url:"/api/Order/GetPaymentTypeEnum",type:"POST"})},Reorder:function(e){return $.ajax({url:"/api/Order/Reorder/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{ohid:e}})}},Coker.Payment={GetPaymentInfo:function(e){return $.ajax({url:"/api/ShoppingCart/GetPaymentInfo/",type:"GET",contentType:"application/json; charset=utf-8",headers:{Authorization:"Bearer "+localStorage.getItem("token")},data:{paytypeid:e}})}},$("#btn_car_dropdown").addClass("d-none"),(buy_step_swiper=new Swiper("#BuyStepSwiper > .swiper",{slidesPerView:1,spaceBetween:15,autoHeight:!0,loop:!1,enabled:!1,pagination:{el:".swiper_pagination > .swiper_pagination_buystep",clickable:!0,renderBullet:function(e,t){return`<span class="${t}">${e+1}</span>`}},navigation:{nextEl:".btn_swiper_next_buystep",prevEl:".btn_swiper_prev_buystep"}})).on("slideChangeTransitionEnd",(function(){gotop_switch&&window.scrollTo(0,$(".swiper").offset().top-$("header").height())})),buy_step_swiper.on("slideChange",(function(){switch(buy_step_swiper.activeIndex){case 2:RadioPayment(),0==ShippingForms.find("input").length?(Coker.sweet.error("錯誤","店家尚未設置運費方式，無法繼續",null,!1),buy_step_swiper.slideTo(1)):0==PaymentForms.find("input").length?(Coker.sweet.error("錯誤","店家尚未設置付款方式，無法繼續",null,!1),buy_step_swiper.slideTo(1)):(shipMethodsChosen=FormCheck(ShippingForms),payMethodsChosen=FormCheck(PaymentForms),shipMethodsChosen&&payMethodsChosen?(OrdererFilled=FormCheck(OrdererForms),RecipientFilled=FormCheck(RecipientForms),InvoiceFilled=FormCheck(InvoiceForms),OrdererFilled||($("#OrdererForm>form").removeClass("was-validated"),OrdererEdit(),$("#radio_recipient_order").trigger("change"),$("#radio_bill_orderer").trigger("change"))):(Coker.sweet.error("請確實選擇運送及付款方式！",null,!0),setTimeout((function(){buy_step_swiper.slideTo(1)}),1500)));break;case 3:isCheckout||(OrdererOpen&&(OrdererFilled=FormCheck(OrdererForms)),RecipientOpen&&(RecipientFilled=FormCheck(RecipientForms)),InvoiceOpen&&(InvoiceFilled=FormCheck(InvoiceForms)),Coker.sweet.error("未完成結帳流程！","若資料已確實填寫完畢，請點選下方[確認付款]按鈕進入付款程序",null,!1),setTimeout((function(){buy_step_swiper.slideTo(2)}),1500))}})),"onhashchange"in window?window.onhashchange=hashChange:setInterval(hashChange,1e3),GetOrderPage(),Coker.Token.CheckToken().done((function(e){islogin=e.isLogin,Coker.User.GetUser().done((function(e){if(e.success){var t=!0;user_data.orderer=e.data.name,user_data.ordererSex=e.data.sex,user_data.ordererEmail=e.data.email,null==e.data.cellPhone?t=!1:user_data.ordererCellphone=e.data.cellPhone,null!=e.data.telPhone&&(user_data.zone=e.data.telPhone.split("-")[0],user_data.ordererTelephone=e.data.telPhone.split("-")[1],user_data.ext=e.data.telPhone.split("-")[2]),null!=e.data.address?(user_data.county=e.data.address.split(" ")[0],user_data.district=e.data.address.split(" ")[1],user_data.ordererAddress=e.data.address.split(" ")[2],user_data.address=e.data.address):t=!1,t||$(".btn_edit_data").on("click"),co.Form.insertData(user_data,"#Form_Orderer"),(order_data=user_data).ordererAddress=user_data.address,DataInsert(order_data,$("#OrdererForm .default_data")),RecipientSameOrderer(),co.Zipcode.setData({el:$("#Orderer_TWzipcode"),addr:order_data.ordererAddress})}else user_data=null}))})),ElementInit(),$(".btn_call_login").on("click",(function(e){loginModal.show()})),top_position=$(".swiper").offset().top,$(window).scroll((function(){var e=$(".swiper").offset().top-$("header").height();gotop_switch=document.body.scrollTop>e||document.documentElement.scrollTop>e})),document.addEventListener("keyup",AutoSwapInput),$("input,label,button").mousedown((function(e){buy_step_swiper.allowTouchMove=!1})),$("input,label,button").mouseup((function(e){buy_step_swiper.allowTouchMove=!0})),ShippingForms=$("#RadioShipping"),PaymentForms=$("#RadioPayment"),$(".btn_swiper_next_step3").on("click",Step2Monitor),OrdererForms=$("#OrdererForm > form"),RecipientForms=$("#RecipientForm > form"),InvoiceForms=$("#InvoiceForm > form"),$(".btn_checkout").on("click",Step3Monitor),$(".btn_back_to_check").on("click",(function(){buy_step_swiper.slideTo(0)})),$(".btn_goprev").on("click",(function(){buy_step_swiper.slidePrev()})),$(".btn_edit_data").on("click",OrdererEdit),$(".btn_delete_recipient").on("click",DeleteRecipient),$("input[type=radio][name=RadioShipping]").on("change",RadioShipping),$("input[type=radio][name=RadioPayment]").on("change",RadioPayment),$("input[type=radio][name=RecipientRadio]").on("change",RecipientRadio),$("input[type=radio][name=InvoiceRadio]").on("change",InvoiceRadio),$(".btn_backshop").on("click",(function(){return history.back(),!1}))}function hashChange(e){e?(e.preventDefault(),GetOrderPage()):console.log("HashChange錯誤")}function GetOrderPage(){if($.isNumeric(window.location.search.substring(1))){isCheckout=!0;var e=parseInt(window.location.search.substring(1));Coker.Order.GetAllData(e,!0).done((function(e){if(e.length>0){var t=e[0];switch($("#Step4 > .card-header > .order_number").text(window.location.search.substring(1)),t.orderHeader.stateStr){case"待確認":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，謝謝您的訂購！");break;case"已付款":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立並完成付款，謝謝您的訂購！");break;case"已取消":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已取消。");break;case"付款失敗":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單付款失敗！"),$(".buyagain_text").length>0&&($(".buyagain_text").removeClass("d-none"),$(".buyagain_text span").on("click",(function(){var e=parseInt($("#Step4 .card-header .order_number").text());Coker.Order.Reorder(e).done((function(e){if(e.success){var t=`000000000${e.message}`.substring(e.message.length);window.location.href=`/${OrgName}/ShoppingCar?reorder${t}`}else Coker.sweet.error("錯誤",e.message)}))})));break;case"待付款":$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，待商家確認付款資訊，謝謝您的訂購！")}SuccessPageDataInsert(t)}else islogin?$("#Step4 > .card-body > .pruchase_content > .status_alert").text("查無訂單資訊或期限已過，請至會員管理歷史訂單中確認"):$("#Step4 > .card-body > .pruchase_content > .status_alert").text("查無訂單資訊");buy_step_swiper.enable(),buy_step_swiper.slideTo(4),buy_step_swiper.disable()}))}else if(window.location.search.substring(1).startsWith("reorder")){e=parseInt(window.location.search.substring("reorder".length+1));Coker.Order.GetReorder(e).done((function(e){e.success&&null!=e.orderHeader&&null!=e.orderDetails?($("#Step1 > .card-body").removeClass("d-none"),buy_step_swiper.enable(),$("#Purchase_Null").addClass("d-none"),CartInit(e.orderDetails)):window.location.href=`/${OrgName}/ShoppingCar`}))}}function SuccessPageDataInsert(e){var t=e.orderHeader,r=e.orderDetails;DataInsert(t,$("#Step4 .card-body")),TemplateDataInsert($("#Purchase"),$("#CollapsePurchase"),$("#Template_Purchase_Details"),r)}function ElementInit(){$Orderer_TWzipcode=$("#Orderer_TWzipcode"),$Recipient_TWzipcode=$("#Recipient_TWzipcode"),$Invoice_TWzipcode=$("#Invoice_TWzipcode"),TWZipCodeInit(),$orderer_name=$("#OrdererInputName"),$orderer_sex=$("input[name=OrdererRadioGender]"),$orderer_email=$("#OrdererInputMail"),$orderer_cellphone=$("#OrdererInputCellPhone"),$orderer_telphone_area=$("#OrdererInputTelPhoneArea"),$orderer_telphone=$("#OrdererInputTelPhone"),$orderer_telphone_ext=$("#OrdererInputTelPhoneExt"),$orderer_address_city=$Orderer_TWzipcode.children(".county").children("select"),$orderer_address_town=$Orderer_TWzipcode.children(".district").children("select"),$orderer_address=$("#OrdererInputAddress"),$recipient_radio=$("input[name=RecipientRadio]"),$recipient_name=$("#RecipientInputName"),$recipient_sex=$("input[name=RecipientRadioGender]"),$recipient_email=$("#RecipientInputMail"),$recipient_cellphone=$("#RecipientInputCellPhone"),$recipient_telphone_area=$("#RecipientInputTelPhoneArea"),$recipient_telphone=$("#RecipientInputTelPhone"),$recipient_telphone_ext=$("#RecipientInputTelPhoneExt"),$recipient_address_city=$Recipient_TWzipcode.children(".county").children("select"),$recipient_address_town=$Recipient_TWzipcode.children(".district").children("select"),$recipient_address=$("#RecipientInputAddress"),$remark=$("#TextareaRemark"),$invoice_recipient=$("input[name=InvoiceRadio]"),$invoice_title=$("#InvoiceInputTitle"),$invoice_uniformid=$("#InvoiceInputUniformId"),$invoice_address_city=$Invoice_TWzipcode.children(".county").children("select"),$invoice_address_town=$Invoice_TWzipcode.children(".district").children("select"),$invoice_address=$("#InvoiceInputAddress"),($ship_method=$("input[name=RadioShipping]")).each((function(){$(this).is(":checked")?(shipping=$(this).val(),ori_freight=$(this).data("freight"),low_con=$(this).data("lowcon"),disfreight=$(this).data("disfreight"),freight=ori_freight):freight=0})),$pay_method=$("input[name=RadioPayment]")}function CardDataGet(){Product.GetAll.Cart().done((function(e){e.length>0&&CartInit(e)}))}function CartInit(e){$("#Step1 > .card-body").removeClass("d-none");for(var t=0;t<e.length;t++)CartAdd(e[t]);$("#Purchase_Null").addClass("d-none"),buy_step_swiper.enable();Array.prototype.slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')).map((function(e){return new bootstrap.Popover(e)}));buy_step_swiper.update(),TotalCount(),PaymentForms.children("div").each((function(){var e=$(this),t=e.find("input").attr("id").replaceAll("radio_payment_","");t.toLowerCase().startsWith("pchome")&&(t.startsWith("PchomePayInstallment")?(t="CARD",e.attr("data-paycode",t)):t.startsWith("PchomePay")?(t=t.replaceAll("PchomePay",""),e.attr("data-paycode",t)):t.startsWith("PCHome")&&(t=t.replaceAll("PCHome",""),e.attr("data-paycode",t)))})),PaymentHideShow()}function PaymentHideShow(){if(PaymentForms.find("div[data-paycode]").removeClass("d-none"),subtotal<1?PaymentForms.find("div[data-paycode]").addClass("d-none"):(subtotal<65&&PaymentForms.find("div[data-paycode^='IP']").addClass("d-none"),subtotal<30&&PaymentForms.find("div[data-paycode='CARD']").addClass("d-none"),subtotal<25&&PaymentForms.find("div[data-paycode]").addClass("d-none")),subtotal>199999){(e=PaymentForms.find("div[data-paycode]")).length>0&&e.addClass("d-none")}else{var e;if(subtotal>2e4)(e=PaymentForms.find("div[data-paycode^='IP'], div[data-paycode='IBRCD']")).length>0&&e.addClass("d-none");if(subtotal>49999)(e=PaymentForms.find("div[data-paycode='ATM'], div[data-paycode='EACH']")).length>0&&e.addClass("d-none")}}function CartAdd(e){void 0===e.pId&&(e.pId=e.prodId);var t=$("#Step1 > .card-body > .purchase_list"),r=$($("#Template_Cart_Details").html()).clone(),a=r.find(".pro_link"),i=r.find(".pro_image"),n=r.find(".pro_name"),o=r.find(".pro_specification"),d=r.find(".pro_unit"),s=r.find(".pro_quantity"),c=r.find(".pro_subtotal"),l=r.find(".btn_count_plus"),p=r.find(".btn_count_minus"),u=r.find(".btn_remove_pro");if(0==parseInt(e.quantity))i.attr("src",e.imagePath),i.attr("alt",`${e.title}的圖片`),n.text(e.title),o.append(""==e.s1Title?"":'<span class="border px-1 me-1">'+e.s1Title+"</span>"),o.append(""==e.s2Title?"":'<span class="border px-1">'+e.s2Title+"</span>"),r.find(".nostock").removeClass("d-none"),r.find(".content").addClass("d-none"),r.find(".btn_side_icon").addClass("d-none"),c.data("subtotal",0);else if(r.data("scid",e.scId),void 0===e.pId?a.attr("href",`/${OrgName}/Home/product/`+e.prodId):a.attr("href",`/${OrgName}/Home/product/`+e.pId),a.attr("title",`連結至：${e.title}(另開新視窗)`),i.attr("src",e.imagePath),i.attr("alt",`${e.title}的圖片`),n.text(e.title),o.append(""==e.s1Title?"":'<span class="border px-1 me-1">'+e.s1Title+"</span>"),o.append(""==e.s2Title?"":'<span class="border px-1">'+e.s2Title+"</span>"),$.isNumeric(e.price)?d.text(parseInt(e.price).toLocaleString("en-US")):d.text(e.price),parseInt(e.oldPrice)>0&&(r.find(".pro_old_unit").removeClass("d-none"),$.isNumeric(e.price)?r.find(".pro_old_unit").text(parseInt(e.oldPrice).toLocaleString("en-US")):r.find(".pro_old_unit").text(e.oldPrice),d.addClass("red_text")),s.val(e.quantity),c.data("subtotal",e.price*e.quantity),c.text(c.data("subtotal").toLocaleString("en-US")),u.on("click",(function(){var e=$(this).parents("li").first();Coker.sweet.confirm("確定將商品從購物車移除？","該商品將會從購物車中移除，且不可復原。","確認移除","取消",(function(){CartDelete(e,e.data("scid"),"成功移除商品","移除商品發生未知錯誤")}))})),l.on("click",(function(){var t=$(this).siblings(".pro_quantity");t.val(parseInt(t.val())+1),CartQuantityUpdate(c,e.price,r.data("scid"),t.val())})),p.on("click",(function(){var t=$(this).siblings(".pro_quantity");t.val()>1&&(t.val(parseInt(t.val())-1),CartQuantityUpdate(c,e.price,r.data("scid"),t.val()))})),s.on("change",(function(){var t=$(this);t.val()<1&&t.val(1),CartQuantityUpdate(c,e.price,r.data("scid"),t.val())})),r.find(".btn_move_to_favorites").length>0&&islogin){var _=r.find(".btn_move_to_favorites");_.parent("span").removeClass("d-none"),Coker.Favorites.Check(e.pId).done((function(e){e.success&&(_.data("Fid",e.message),_.find("i").addClass("fa-solid"),_.find("i").removeClass("fa-regular"))})),_.on("click",(function(){var t=$(this).find("i");t.hasClass("fa-regular")?Coker.Favorites.Add(e.pId).done((function(e){e.success?(_.data("Fid",e.message),t.addClass("fa-solid"),t.removeClass("fa-regular"),Coker.sweet.success("成功將商品加入收藏",null,!0)):console.log(e.message)})):void 0!==_.data("Fid")&&""!=typeof _.data("Fid")&&Coker.Favorites.Delete(_.data("Fid")).done((function(e){e.success?(_.data("Fid",""),t.addClass("fa-regular"),t.removeClass("fa-solid"),Coker.sweet.success("已將商品從收藏中移除",null,!0)):console.log(e.message)}))}))}t.append(r)}function CartQuantityUpdate(e,t,r,a){Product.Update.Cart({Id:r,Quantity:a}).done((function(i){Product.GetOne.Cart(i.message).done((function(i){e.data("subtotal",t*a),e.text(e.data("subtotal").toLocaleString("en-US")),TotalCount(),CartDropReset(r,a)}))})).fail((function(){Coker.sweet.error("錯誤","商品數量修改發生錯誤",null,!0)}))}function TotalCount(){subtotal=0,$(".purchase_list").children("li").each((function(){subtotal+=$(this).children(".content").children(".pro_subtotal").data("subtotal"),freight=subtotal>low_con?disfreight:ori_freight})),$(".subtotal").each((function(){$(this).text(subtotal.toLocaleString())})),$(".shipping_fee").each((function(){$(this).text(null==freight||""==freight||""==freight?0:freight.toLocaleString())})),$(".total_amount").each((function(){total=null==freight||""==freight?subtotal:subtotal+freight,$(this).text(parseInt(total).toLocaleString())})),PaymentHideShow()}function CartDelete(e,t,r,a){e.remove(),Product.Delete.Cart(t).done((function(){Coker.sweet.success(r,null,!0),CartDropReset(t,0),TotalCount(),0==parseInt($("#Car_Badge").text())&&DetailsClear()})).fail((function(){Coker.sweet.error("錯誤",a,null,!0)}))}function Step2Monitor(){shipMethodsChosen=FormCheck(ShippingForms),payMethodsChosen=FormCheck(PaymentForms),shipMethodsChosen&&payMethodsChosen?buy_step_swiper.slideNext():Coker.sweet.error("請確實選擇運送及付款方式！",null,!0),buy_step_swiper.update()}function RadioShipping(){ori_freight=$(this).data("freight"),low_con=$(this).data("lowcon"),disfreight=$(this).data("disfreight"),freight=ori_freight,TotalCount()}function RadioPayment(){var e=$(".payment_method");e.addClass("fs-2 fw-bold px-3"),$pay_method.each((function(){var t=$(this);t.is(":checked")&&(1==t.val()?$(".pay_info").removeClass("d-none"):$(".pay_info").addClass("d-none"),e.text(t.siblings("label").text()))})),buy_step_swiper.update()}function Step3Monitor(){if(OrdererOpen&&(OrdererFilled=FormCheck(OrdererForms)),RecipientOpen)RecipientFilled=FormCheck(RecipientForms);else if("order"===$('[name="RecipientRadio"]:checked').val())RecipientSameOrderer(),RecipientFilled=!0;if(InvoiceOpen)InvoiceFilled=FormCheck(InvoiceForms);else switch($('[name="InvoiceRadio"]:checked').val()){case"order":case"recipient":InvoiceFilled=!0}OrdererFilled?RecipientFilled?InvoiceFilled?Coker.sweet.confirm("是否確定結帳？","點選確認進入付款流程","是，開始付款","否",(function(){OrderHeaderAdd()})):Coker.sweet.error("請確實填寫發票寄送資料！",null,!0):Coker.sweet.error("請確實填寫收件人資料！",null,!0):Coker.sweet.error("請確實填寫訂購人資料！",null,!0),buy_step_swiper.update()}function OrdererEdit(){OrdererOpen&&(order_data={},order_data=user_data),$("#OrdererForm > .default_data").toggleClass("d-none"),$("#OrdererForm > form").toggleClass("d-none"),OrdererFilled=!(OrdererOpen=!OrdererOpen),buy_step_swiper.update()}function RecipientRadio(){var e=$(this);recipient_data={},"edit"==e.val()?($("#RecipientForm > .default_data").addClass("d-none"),$("#RecipientForm > form").removeClass("d-none"),RecipientOpen=!0,RecipientFilled=!1,RecipientFormClear()):"order"==e.val()?($("#RecipientForm > .default_data").addClass("d-none"),$("#RecipientForm > form").addClass("d-none"),RecipientOpen=!1,RecipientFilled=!0,RecipientSameOrderer()):($("#RecipientForm > .default_data").addClass("d-none"),$("#RecipientForm > form").addClass("d-none"),RecipientOpen=!1,RecipientFilled=!0),buy_step_swiper.update()}function RecipientFormClear(){$recipient_name.val(""),$recipient_sex.val(""),$recipient_sex.each((function(){$(this).removeAttr("checked")})),$recipient_email.val(""),$recipient_cellphone.val(""),$recipient_telphone_area.val(""),$recipient_telphone.val(""),$recipient_telphone_ext.val(""),$recipient_address_city.val(""),$recipient_address_town.val(""),$recipient_address.val(""),$remark.val("")}function RecipientSameOrderer(){for(var e in order_data)e.startsWith("orderer")>0&&(recipient_data[e.replace("orderer","recipient")]=order_data[e])}function InvoiceRadio(){switch(invoice_data={},this.value){case"order":case"recipient":$("#InvoiceForm > .default_data").addClass("d-none"),$("#InvoiceForm > form").addClass("d-none"),InvoiceOpen=!1,InvoiceFilled=!0;break;case"company":$("#InvoiceForm > .default_data").addClass("d-none"),$("#InvoiceForm > form").removeClass("d-none"),InvoiceOpen=!0,InvoiceFilled=!1,InvoiceFormClear()}buy_step_swiper.update()}function InvoiceFormClear(){$invoice_title.val(""),$invoice_uniformid.val(""),$invoice_address_city.val(""),$invoice_address_town.val(""),$invoice_address.val("")}function InvoiceFormSet(e,t,r,a,i){$invoice_title.val(e),$invoice_uniformid.val(t),$Invoice_TWzipcode.twzipcode("set",{county:r,district:a}),$invoice_address.val(i)}function FormCheck(e){var t=!1;return Array.from(e).forEach((e=>{e.checkValidity()&&(t=!0),e.classList.add("was-validated")})),t}function DetailsClear(){$("#Step1 > .card-body").addClass("d-none"),$("#Purchase_Null").removeClass("d-none"),buy_step_swiper.disable()}function DeleteRecipient(){$(this).parents("tr").remove()}function OrderHeaderAdd(){var e=!0;for(var t in OrdererOpen?((order_data=co.Form.getJson($("#Form_Orderer").attr("id"))).ordererAddress=`${order_data.county} ${order_data.district} ${order_data.ordererAddress}`,""==order_data.zone^""==order_data.ordererTelephone?(Coker.sweet.error("資料填寫錯誤","如要提供訂購人電話資訊，請確實填寫區碼與聯絡電話。",null,!1),e=!1):""==order_data.zone&&""==order_data.ordererTelephone?order_data.ordererTelephone=null:order_data.ordererTelephone=`${order_data.zone}-${order_data.ordererTelephone}`+(""==order_data.ext?"":`-${order_data.ext}`)):null==user_data?(e=!1,Coker.sweet.error("資料填寫錯誤","請確實填寫訂購人資訊。",null,!1),OrdererEdit()):(order_data=user_data).ordererAddress=user_data.address,order_data)t.startsWith("orderer")>0&&(order_header_data[t]=order_data[t]);switch($('[name="RecipientRadio"]:checked').val()){case"order":RecipientSameOrderer();break;case"edit":(recipient_data=co.Form.getJson($("#Form_Recipient").attr("id"))).recipientAddress=`${recipient_data.county} ${recipient_data.district} ${recipient_data.recipientAddress}`,""==recipient_data.zone^""==recipient_data.recipientTelephone?(Coker.sweet.error("資料填寫錯誤","如要提供收件人電話資訊，請確實填寫區碼與聯絡電話。",null,!1),e=!1):""==recipient_data.zone&&""==recipient_data.recipientTelephone?recipient_data.recipientTelephone=null:recipient_data.recipientTelephone=`${recipient_data.zone}-${recipient_data.recipientTelephone}`+(""==recipient_data.ext?"":`-${recipient_data.ext}`)}for(var t in recipient_data)t.startsWith("recipient")>0&&(order_header_data[t]=recipient_data[t]);switch(void 0===recipient_data.remark||""==recipient_data.remark?order_header_data.remark="無":order_header_data.remark=recipient_data.remark,$('[name="InvoiceRadio"]:checked').val()){case"order":invoice_data.invoiceRecipient=1,invoice_data.invoiceAddress=order_data.ordererAddress;break;case"recipient":invoice_data.invoiceRecipient=2,invoice_data.invoiceAddress=recipient_data.recipientAddress;break;case"company":(invoice_data=co.Form.getJson($("#Form_Invoice").attr("id"))).invoiceAddress=`${invoice_data.county} ${invoice_data.district} ${invoice_data.invoiceAddress}`,invoice_data.invoiceRecipient=3,order_header_data.uniformId=invoice_data.uniformId}for(var t in invoice_data)t.startsWith("invoice")>0&&(order_header_data[t]=invoice_data[t]);order_header_data.shipping=$('[name="RadioShipping"]:checked').val(),order_header_data.payment=$('[name="RadioPayment"]:checked').val(),order_header_data.state=1,order_header_data.subtotal=subtotal,order_header_data.discount=0,order_header_data.bonus=0,order_header_data.couponId=0,order_header_data.freight=""==freight?0:freight,order_header_data.Service_Charge=0,e&&(Coker.sweet.loading(),Coker.Order.AddHeader(order_header_data).done((function(e){e.success?Coker.sweet.success("謝謝您的訂購！<br />訂單處理中，若有錯誤請修正後重送訂單。請勿按[回上頁]按鈕，以免重複下單，或發生其他不可預期的錯誤！",(function(){OrderSuccess(e),setTimeout((function(){isCheckout=!0;var t=e.message.split(",")[0];switch(t){case"LinePay":case"PCHomePay":Coker.ThirdParty.Request(e.message.split(",")[1],t).done((function(e){e.success?(localStorage.setItem("lastSaveTime",(new Date).toISOString()),localStorage.setItem("lastSaveToken",localStorage.getItem("token")),$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，即將進入付款流程。"),setTimeout((function(){buy_step_swiper.slideNext(),buy_step_swiper.disable()}),300),window.open(e.message,"_blank")):($("#Step4 > .card-body > .pruchase_content > .status_alert").text("付款流程發生未知錯誤，請稍後重新嘗試，或直接聯繫客服人員。"),setTimeout((function(){buy_step_swiper.slideNext(),buy_step_swiper.disable()}),300))}));break;case"Default":setTimeout((function(){buy_step_swiper.slideNext(),buy_step_swiper.disable()}),300)}}),300)})):(console.log(e),Coker.sweet.error("錯誤","訂購商品發生未知錯誤",null,!0))})).fail((function(e){console.log(e),Coker.sweet.error("錯誤","訂購商品發生未知錯誤",null,!0)})))}function OrderSuccess(e){var t=e.message.split(","),r=t[1];switch(CartClear(),$("#Step4 > .card-header > .order_number").text(("000000000"+r).substr(r.length)),$("#Step4 > .card-body > .pruchase_content > .status_alert").text("訂單已成立，謝謝您的訂購！"),""!=$(".storememo").text()?Swal.fire({title:"小提醒",icon:"info",html:$(".storememo").text().replaceAll("\n","<br/>"),focusConfirm:!1,confirmButtonText:"確認"}).then((t=>{null!=e.error&&(islogin?Coker.sweet.error("信件發送失敗","訂購信件發送失敗，訂單詳細可於會員管理歷史訂單中查看。"):Coker.sweet.error("信件發送失敗","訂購信件發送失敗，請註冊會員以查看詳細訂單，或將訂單完成頁面截圖。"))})):null!=e.error&&(islogin?Coker.sweet.error("信件發送失敗","訂購信件發送失敗，訂單詳細可於會員管理歷史訂單中查看。"):Coker.sweet.error("信件發送失敗","訂購信件發送失敗，請註冊會員以查看詳細訂單，或將訂單完成頁面截圖。")),$(".storememo").empty(),DataInsert(order_data,$("#Step4 .orderer_data")),DataInsert(recipient_data,$("#Step4 .recipient_data")),invoice_data.invoiceRecipient){case 1:DataInsert(order_data,$("#Step4 .invoice_data .orderer")),$("#Step4 .invoice_data .orderer").removeClass("d-none");break;case 2:DataInsert(recipient_data,$("#Step4 .invoice_data .recipient")),$("#Step4 .invoice_data .recipient").removeClass("d-none");break;case 3:DataInsert(invoice_data,$("#Step4 .invoice_data .company")),$("#Step4 .invoice_data .company").removeClass("d-none")}$("#PaymentData .pay_info .paid_date").append(`${t[2]}<span>${t[3]}23點59分</span>`);var a=order_header_data.ordererEmail;$("#PaymentData .pay_mail").append(`如因交易條件有誤、商品缺貨或價格物刊或有其他本公司無法接受訂單之情形,本公司保留商品出貨與否的權利。<br />．隨後我們也會將轉帳的資料mail到您指定的電子信箱:${a.substr(0,1)}******${a.substr(a.indexOf("@")-1)}`),Coker.Order.GetDetails(r).done((function(e){if(e.length>0){e.length>1&&$(".btn_view_list").removeClass("d-none");for(var t=0;t<e.length;t++)PurchaseAdd(e[t],0==t?$("#Step4 > .card-body > .pruchase_content > .purchase_list").first():$("#Step4 > .card-body > .pruchase_content > .purchase_list.collapse"))}})),Coker.Payment.GetPaymentInfo(order_header_data.payment).done((function(e){if(null!=e&&e.length>0){var t="";$.each(e,(function(e,r){t+=`<div class="mb-2 row">\n                                        <div class="col-auto col-sm-2 py-0 text-end">${r.title}：</div>\n                                        <div class="col ps-0">${r.value}</div>\n                                    </div>`})),$(".pay_info > div").prepend(t)}}))}function PurchaseAdd(e,t){var r=$($("#Template_Purchase_Details").html()).clone(),a=r.find(".pro_link"),i=r.find(".pro_image"),n=r.find(".pro_name"),o=r.find(".pro_specification"),d=r.find(".pro_unit"),s=r.find(".pro_quantity"),c=r.find(".pro_subtotal");a.attr("href",`/${OrgName}/Home/product/`+e.pId),a.attr("title",`連結至：${e.title}(另開新視窗)`),console.log("result.imagePath",e.imagePath),console.log("result.imagePath",e.imagePath.replace(`upload/${OrgName}/`,"upload/")),i.attr("src",e.imagePath.replace(`upload/${OrgName}/`,"upload/")),n.text(e.title),o.append(""==e.s1Title?"":'<span class="border px-1 me-1">'+e.s1Title+"</span>"),o.append(""==e.s2Title?"":'<span class="border px-1">'+e.s2Title+"</span>"),d.text(`$${e.price.toLocaleString("en-US")}`),s.text(e.quantity),c.text((e.price*e.quantity).toLocaleString("en-US")),t.append(r)}function HiddenCode(e){e.find("*").each((function(){var e=$(this);e.data("key");if(void 0!==e.data("key"))switch(e.data("type")){case"name":var t=e.text();e.text(`${t.substr(0,1)}○${t.substr(t.length-1)}`);break;case"email":var r=e.text();e.text(`${r.substr(0,3)}**********`);break;case"phone":var a=e.text();e.text(`${a.substr(0,3)}****${a.substr(a.length-3)}`);break;case"address":var i=e.text();i=i.split(" ")[0]+i.split(" ")[1]+i.split(" ")[2],e.text(`${i.substr(0,9)}*****`);break;case"uniformId":var n=e.text();e.text(`${n.substr(0,3)}*****`)}}))}function DataInsert(e,t){if(void 0!==e.invoiceRecipient)switch(parseInt(e.invoiceRecipient)){case 1:$(".invoice_data .orderer").removeClass("d-none");break;case 2:$(".invoice_data .recipient").removeClass("d-none");break;case 3:$(".invoice_data .company").removeClass("d-none")}t.find("*").each((function(){var t=$(this),r=t.data("key");void 0!==t.data("key")&&(t.hasClass("price")?t.text(e[r].replace("$","")):t.text(e[r]))}))}function TemplateDataInsert(e,t,r,a){$.each(a,(function(a,i){var n=$(r.html()).clone();n.find("*").each((function(){var e=$(this),t=e.data("key");if(void 0!==e.data("key"))switch(t){case"link":e.attr({href:`/${OrgName}/Home/product/${i.prodId}`,title:`連結至：${i.title}(另開新視窗)`});break;case"imagePath":console.log("data[key]",i[t]),i[t]=i[t].replace(`/${OrgName}/`,"/"),console.log("data[key]",i[t]),e.attr({src:i[t],alt:i.title});break;case"spec":e.append(""==i.s1Title?"":`<span class="border px-1 me-1">${i.s1Title}</span>`),e.append(""==i.s2Title?"":`<span class="border px-1 me-1">${i.s2Title}</span>`);break;default:e.hasClass("price")&&!e.hasClass("pro_unit")?e.text(i[t].replace("$","")):e.text(i[t])}})),0==a?e.append(n):($(".btn_view_list").removeClass("d-none"),t.append(n))}))}function AutoSwapInput(){var e=event.target;if("INPUT"==e.nodeName&&e.className.indexOf("pro_quantity")<0&&e.value.length==e.maxLength){var t=$(e).parents("form").first().find("input");for(let r=0;r<t.length;r++)if(t[r]==e)return void(t[r+1]&&t[r+1].focus())}}function TWZipCodeInit(){var e,t,r,a;$Orderer_TWzipcode.twzipcode({zipcodeIntoDistrict:!0,countySel:"高雄市",districtSel:"前鎮區"}),$Recipient_TWzipcode.twzipcode({zipcodeIntoDistrict:!0}),$Invoice_TWzipcode.twzipcode({zipcodeIntoDistrict:!0}),e=$Orderer_TWzipcode.children(".county"),t=$Orderer_TWzipcode.children(".district"),e.children("select").attr({id:"OrdererSelectCity",class:"orderer_city form-select",required:"required"}),e.append("<label class='px-4 required' for='OrdererSelectCity'>縣市</label>"),(r=e.children("select").children("option").first()).text("請選擇縣市"),r.attr("disabled","disabled"),t.children("select").attr({id:"OrdererSelectTown",class:"orderer_town form-select",required:"required"}),t.append("<label class='px-4 required' for='OrdererSelectCity'>鄉鎮</label>"),(a=t.children("select").children("option").first()).text("請選擇鄉鎮"),a.attr("disabled","disabled"),e=$Recipient_TWzipcode.children(".county"),t=$Recipient_TWzipcode.children(".district"),e.children("select").attr({id:"RecipientSelectCity",class:"recipient_city form-select",required:"required"}),e.append("<label class='px-4 required' for='RecipientSelectCity'>縣市</label>"),(r=e.children("select").children("option").first()).text("請選擇縣市"),r.attr("disabled","disabled"),t.children("select").attr({id:"RecipientSelectTown",class:"recipient_town form-select",required:"required"}),t.append("<label class='px-4 required' for='RecipientSelectCity'>鄉鎮</label>"),(a=t.children("select").children("option").first()).text("請選擇鄉鎮"),a.attr("disabled","disabled"),e=$Invoice_TWzipcode.children(".county"),t=$Invoice_TWzipcode.children(".district"),e.children("select").attr({id:"InvoiceSelectCity",class:"bill_city form-select",required:"required"}),e.append("<label class='px-4 required' for='InvoiceSelectCity'>縣市</label>"),(r=e.children("select").children("option").first()).text("請選擇縣市"),r.attr("disabled","disabled"),t.children("select").attr({id:"InvoiceSelectTown",class:"bill_town form-select",required:"required"}),t.append("<label class='px-4 required' for='InvoiceSelectCity'>鄉鎮</label>"),(a=t.children("select").children("option").first()).text("請選擇鄉鎮"),a.attr("disabled","disabled")}