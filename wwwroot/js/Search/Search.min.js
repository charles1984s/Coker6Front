function PageReady(){const e=$(".search-category>.container>button"),t=$(".search-category .catalog_frame"),a=$(".search-suggestions");let i=null;(async()=>{const e=new LocalDb({apiUrl:"/api/Directory/GetSearchKeyList",dbName:"searchDB",storeName:"searchStore"});try{let n=await e.getData();$(".search-input").on("change",(function(){const a=this;setTimeout((async()=>{const i=$(a).val().toLowerCase();if(""!=i){try{""!=i.trim()&&await e.addOrUpdateData(i)}catch(e){console.error("儲存關鍵字時發生錯誤:",e)}t.data("search-text",$(a).val()),window.location.href=`/${OrgName}/Search/Get/${t.data("dirid")}/${t.data("search-text")}`}}),300)})),$("body").on("click.hideSuggestions",(function(e){$(".search-suggestions").addClass("d-none"),$(".search-category .search-input").removeClass("suggestions")})),$(".search-input").on("focus",(function(e){e.preventDefault(),setTimeout((()=>{$(this).trigger("input")}),300)})),$(".search-input").on("input",(async function(){const t=$(this).val().toLowerCase(),i=n.filter((e=>"local"===e.type&&e.key.toLowerCase().includes(t))),r=n.filter((e=>"remote"===e.type&&e.key.toLowerCase().includes(t)));if(a.empty(),i.length>0||r.length>0){if(i.length>0){const t=$("<button class='clear-local'>全部清空<span class=\"material-symbols-outlined\">delete</span></button>"),r=$("<li><ul></ul></li>");i.forEach((e=>{const t=$(`<li class="local-record"><a href="#" title="搜尋：${e.key}">${e.key}</a> <button class="delete-local"><span class="material-symbols-outlined">close</span></button></li>`);r.find("ul").append(t)})),a.append($("<li class='clearAll'>").append(t)),a.append(r),t.on("click",(async()=>{try{await e.clearLocalData(),n=await e.getData(),console.log("本地紀錄已清空"),r.remove(),t.closest("li").remove()}catch(e){console.error("清空本地紀錄失敗:",e)}}))}if(r.length>0){const e=$("<li><strong>熱門關鍵字</strong><ul></ul></li>");r.forEach((t=>{const a=$(`<li><a href="#" title="搜尋：${t.key}">${t.key}</a></li>`);e.find("ul").append(a)})),a.append(e)}a.removeClass("d-none"),$(".search-category .search-input").addClass("suggestions")}else a.addClass("d-none"),$(".search-category .search-input").removeClass("suggestions")})),$(document).on("click",".delete-local",(async function(t){t.preventDefault();const a=$(this).siblings("a").text();try{await e.deleteData(a),$(this).closest("li").remove(),n=await e.getData()}catch(e){console.error("刪除本機資料時發生錯誤:",e)}})),$(document).on("click",".search-suggestions a",(function(e){e.preventDefault();const t=$(this).text();$(".search-input").val(t),$(".search-input").trigger("change"),$(".search-suggestions").addClass("d-none"),$(".search-category .search-input").removeClass("suggestions")}));function i(e){const t=$(".search-suggestions a"),a=$(".search-suggestions");if(e<0||e>=t.length)return;t.removeClass("highlighted");const i=t.eq(e);i.addClass("highlighted");const n=i[0].offsetTop,r=i.outerHeight(),c=(a.scrollTop(),n-a.innerHeight()/2+r/2);a.scrollTop(c)}$(".search-input").on("keydown",(function(e){const t=$(".search-suggestions a");if(!t.length)return;const a=t.filter(".highlighted");let n=t.index(a);switch(e.key){case"ArrowDown":e.preventDefault(),i((n+1)%t.length);break;case"ArrowUp":e.preventDefault(),i((n-1+t.length)%t.length);break;case"Enter":const a=$(".search-suggestions a.highlighted");if("Enter"===e.key&&a.length>0)return e.preventDefault(),void a.trigger("click");"Enter"===e.key&&$(this).trigger("change");case"Tab":n>=0&&t.eq(n).focus()}}))}catch(r){console.error("取得資料時發生錯誤:",r)}})(),e.on("click",(function(){window.location.href=`/${OrgName}/Search/Get/${$(this).data("id")}/${t.data("search-text")}`})),$(".search-category .catalog_frame [name='startDate']").on("change",(function(){t.data("startDate",$(this).val())})),$(".search-category .catalog_frame [name='endDate']").on("change",(function(){t.data("endDate",$(this).val())})),$(".search-category .catalog_frame").on("load",(function(){const e=$(this),t=$("#filterTemp").html(),a=$("#filterList"),n=$(this).data("filter"),r=$("#filterDirTypeTemp").html(),c=$("#filterBlock > .filterDirType > ul");a.empty(),c.empty(),e.data("directoryType").unshift({id:0,name:"全部"}),$("#filterBlock .fa-close").on("click",(function(){$("#filterBlock").removeClass("active"),$("body").removeClass("modal-open")})),$(".btn_filter_grid").on("click",(function(){$("#filterBlock").addClass("active"),$("body").addClass("modal-open")})),$(e.data("directoryType")).each(((t,a)=>{const i=$(r);void 0!==e.data("directoryTypeChecked")&&e.data("directoryTypeChecked")==a.id&&$("#filterBlock > .filterDirType > a").text(a.name),i.find("a").data(a).text(a.name).on("click",(function(){return e.data("directoryTypeChecked",$(this).data("id")),$("#filterBlock > .filterDirType > a").text($(this).data("name")),e.trigger("filter"),!1})),c.append(i)})),$(n).each(((n,r)=>{const c=$(t),o=`filterType${r.type}-${r.id}`,s=c.find("ul"),l=s.html();s.empty();const d=c.find(".filterType>.form-check-input").data("type",r.type).attr("id",o).on("change",(function(){const e=$(this);e.prop("checked")?e.parents("li").find("li .form-check-input").prop("checked",!0).trigger("change"):e.parents("li").find("li .form-check-input").prop("checked",!1).trigger("change")}));if(c.find(".filterType>label").attr("for",o),$(r.tags).each(((t,a)=>{const n=$(l),c=`filterTag${r.type}-${a.fK_TId}`;if(a.count<=0)return;const o=n.children(".form-check-input").data({type:r.type,gid:r.id,id:a.fK_TId}).attr("id",c).on("change",(function(){const t=$(this);clearTimeout(i),void 0===e.data("filtered")&&e.data("filtered",[]),t.prop("checked")?filteredPush(e.data("filtered"),t.data()):filteredPop(e.data("filtered"),t.data()),i=setTimeout((function(){e.trigger("filter")}),1e3)}));if(n.children("label").attr("for",c),n.find(".tagName").text(a.tag_Name),n.find(".count").text(a.count),s.append(n),void 0!==e.data("filtered")){const t=e.data("filtered").filter((e=>e.type==r.type));if(0!=t.length){const e=t[0].group.filter((e=>e.id==r.id));0!=e.length&&e[0].tags.includes(a.fK_TId)&&o.prop("checked",!0).trigger("change")}}})),void 0!==e.data("filtered")){const t=e.data("filtered").filter((e=>e.type==r.type));if(0!=t.length){const e=t[0].group.filter((e=>e.id==r.id));0!=e.length&&e[0].tags.length==r.tags.filter((e=>e.count>0)).length&&d.prop("checked",!0).trigger("change")}}c.find(".typeName").text(r.name),s.children("li").length>0&&a.append(c)})),"3"!=$(".search-category .active").data("id")||""==$(".searchText").text().trim()?$("#filterBlock").addClass("d-none"):$("#filterBlock").removeClass("d-none"),clearTimeout(i)})),$(".searchbtn").on("click",(function(){window.location.href=`/${OrgName}/Search/Get/${t.data("dirid")}/${t.data("search-text")}`}))}function filteredPush(e,t){filteredInsertOrDeleted(e,t,!0)}function filteredPop(e,t){filteredInsertOrDeleted(e,t,!1)}function filteredInsertOrDeleted(e,t,a){const i=e.filter((e=>e.type==t.type));let n=null;0==i.length?(n={type:t.type,group:[]},e.push(n)):n=i[0];const r=n.group.filter((e=>e.id==t.gid));if(0==r.length)n.group.push({id:t.gid,tags:[t.id]});else{const e=r[0].tags;e.includes(t.id)?a||e.splice(e.indexOf(t.id),1):a&&e.push(t.id)}}