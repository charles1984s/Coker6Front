function PageReady(){const e=$(".search-category>.container>button"),t=$(".search-category .catalog_frame");let a=null;(async()=>{const e=new LocalDb({apiUrl:"/api/Directory/GetSearchKeyList",dbName:"searchDB",storeName:"searchStore"});try{const i=await e.getData();$(".search-input").on("input",(function(){const e=$(this).val().toLowerCase(),t=i.filter((t=>t.Key.toLowerCase().includes(e))),a=$(".search-suggestions");a.empty(),t.length>0?(t.forEach((e=>{a.append(`<li><a href="#" title="搜尋：${e.Key}關鍵字">${e.Key}</a></li>`)})),a.show()):a.hide()})),$(document).on("click",".search-suggestions a",(function(e){e.preventDefault();const a=$(this).text();t.data("search-text",a),$(".search-input").val(a),$(".search-suggestions").hide(),$(".search-suggestions a").removeClass("highlighted")}));function a(e){const t=$(".search-suggestions a"),a=$(".search-suggestions");if(e<0||e>=t.length)return;t.removeClass("highlighted");const i=t.eq(e);i.addClass("highlighted");const r=i[0].offsetTop,n=i.outerHeight(),c=(a.scrollTop(),r-a.innerHeight()/2+n/2);a.scrollTop(c)}$(".search-input").on("keydown",(function(e){const t=$(".search-suggestions a");if(!t.length)return;const i=t.filter(".highlighted");let r=t.index(i);switch(e.key){case"ArrowDown":e.preventDefault(),a((r+1)%t.length);break;case"ArrowUp":e.preventDefault(),a((r-1+t.length)%t.length);break;case"Enter":const i=$(".search-suggestions a.highlighted");if("Enter"===e.key&&i.length>0)return e.preventDefault(),void i.trigger("click");"Enter"===e.key&&$(this).trigger("change");case"Tab":r>=0&&t.eq(r).focus()}}))}catch(r){console.error("取得資料時發生錯誤:",r)}})(),e.on("click",(function(){window.location.href=`/${OrgName}/Search/Get/${$(this).data("id")}/${t.data("search-text")}`})),$(".search-category .catalog_frame [name='startDate']").on("change",(function(){t.data("startDate",$(this).val())})),$(".search-category .catalog_frame [name='endDate']").on("change",(function(){t.data("endDate",$(this).val())})),$(".search-category .search-input").on("change",(function(){t.data("search-text",$(this).val()),window.location.href=`/${OrgName}/Search/Get/${t.data("dirid")}/${t.data("search-text")}`})),$(".search-category .catalog_frame").on("load",(function(){const e=$(this),t=$("#filterTemp").html(),i=$("#filterList"),r=$(this).data("filter"),n=$("#filterDirTypeTemp").html(),c=$("#filterBlock > .filterDirType > ul");i.empty(),c.empty(),e.data("directoryType").unshift({id:0,name:"全部"}),$("#filterBlock .fa-close").on("click",(function(){$("#filterBlock").removeClass("active"),$("body").removeClass("modal-open")})),$(".btn_filter_grid").on("click",(function(){$("#filterBlock").addClass("active"),$("body").addClass("modal-open")})),$(e.data("directoryType")).each(((t,a)=>{const i=$(n);void 0!==e.data("directoryTypeChecked")&&e.data("directoryTypeChecked")==a.id&&$("#filterBlock > .filterDirType > a").text(a.name),i.find("a").data(a).text(a.name).on("click",(function(){return e.data("directoryTypeChecked",$(this).data("id")),$("#filterBlock > .filterDirType > a").text($(this).data("name")),e.trigger("filter"),!1})),c.append(i)})),$(r).each(((r,n)=>{const c=$(t),o=`filterType${n.type}`,l=c.find("ul"),s=l.html();l.empty();const d=c.find(".filterType>.form-check-input").data("type",n.type).attr("id",o).on("change",(function(){const e=$(this);e.prop("checked")?e.parents("li").find("li .form-check-input").prop("checked",!0).trigger("change"):e.parents("li").find("li .form-check-input").prop("checked",!1).trigger("change")}));if(c.find(".filterType>label").attr("for",o),$(n.tags).each(((t,i)=>{const r=$(s),c=`filterTag${n.type}-${i.fK_TId}`;if(i.count<=0)return;const o=r.children(".form-check-input").data({type:n.type,gid:n.id,id:i.fK_TId}).attr("id",c).on("change",(function(){const t=$(this);clearTimeout(a),void 0===e.data("filtered")&&e.data("filtered",[]),t.prop("checked")?filteredPush(e.data("filtered"),t.data()):filteredPop(e.data("filtered"),t.data()),a=setTimeout((function(){e.trigger("filter")}),1e3)}));if(r.children("label").attr("for",c),r.find(".tagName").text(i.tag_Name),r.find(".count").text(i.count),l.append(r),void 0!==e.data("filtered")){const t=e.data("filtered").filter((e=>e.type==n.type));if(0!=t.length){const e=t[0].group.filter((e=>e.id==n.id));0!=e.length&&e[0].tags.includes(i.fK_TId)&&o.prop("checked",!0).trigger("change")}}})),void 0!==e.data("filtered")){const t=e.data("filtered").filter((e=>e.type==n.type));if(0!=t.length){const e=t[0].group.filter((e=>e.id==n.id));0!=e.length&&e[0].tags.length==n.tags.length&&d.prop("checked",!0).trigger("change")}}c.find(".typeName").text(n.name),l.children("li").length>0&&i.append(c)})),"3"!=$(".search-category .active").data("id")||""==$(".searchText").text().trim()?$("#filterBlock").addClass("d-none"):$("#filterBlock").removeClass("d-none"),clearTimeout(a)})),$(".searchbtn").on("click",(function(){window.location.href=`/${OrgName}/Search/Get/${t.data("dirid")}/${t.data("search-text")}`}))}function filteredPush(e,t){filteredInsertOrDeleted(e,t,!0)}function filteredPop(e,t){filteredInsertOrDeleted(e,t,!1)}function filteredInsertOrDeleted(e,t,a){const i=e.filter((e=>e.type==t.type));let r=null;0==i.length?(r={type:t.type,group:[]},e.push(r)):r=i[0];const n=r.group.filter((e=>e.id==t.gid));if(0==n.length)r.group.push({id:t.gid,tags:[t.id]});else{const e=n[0].tags;e.includes(t.id)?a||e.splice(e.indexOf(t.id),1):a&&e.push(t.id)}}