function PageReady(){const e=$(".search-category>.container>button"),t=$(".search-category .catalog_frame"),a=$(".search-suggestions");for(var n=sessionStorage.length-1;n>=0;n--){var i=sessionStorage.key(n);(i.startsWith("product-")||i.startsWith("article-"))&&sessionStorage.removeItem(i)}let r=null;(async()=>{const e=new LocalDb({apiUrl:"/api/Directory/GetSearchKeyList",dbName:"searchDB",storeName:"searchStore"});try{let i=await e.getData();$(".search-input").on("change",(function(){const a=this;setTimeout((async()=>{const n=$(a).val().toLowerCase();if(""!=n){try{""!=n.trim()&&void 0!==n&&await e.addOrUpdateData(n)}catch(e){console.error("儲存關鍵字時發生錯誤:",e)}t.data("search-text",$(a).val()),window.location.href=`/${OrgName}/Search/Get/${t.data("dirid")}/${encodeURIComponent(t.data("search-text"))}`}}),300)})),$("body").on("click.hideSuggestions",(function(e){$(".search-suggestions").addClass("d-none"),$(".search-category .input-container").removeClass("suggestions")})),$(".search-input").on("focus",(function(e){e.preventDefault(),setTimeout((()=>{$(this).trigger("input")}),300)})),$(".search-input").on("input",(async function(){const t=$(this).val().toLowerCase(),n=i.filter((e=>"local"===e.type&&e.key.toLowerCase().includes(t))),r=i.filter((e=>"remote"===e.type&&e.key.toLowerCase().includes(t)));if(a.empty(),n.length>0||r.length>0){if(n.length>0){const t=$("<button class='clear-local'>全部清空<span class=\"material-symbols-outlined\">delete</span></button>"),r=$("<li><ul></ul></li>");n.forEach((e=>{const t=$(`<li class="local-record"><a href="#" title="搜尋：${e.key}">${e.key}</a> <button class="delete-local"><span class="material-symbols-outlined">close</span></button></li>`);r.find("ul").append(t)})),a.append($("<li class='clearAll'>").append(t)),a.append(r),t.on("click",(async()=>{try{await e.clearLocalData(),i=await e.getData(),console.log("本地紀錄已清空"),r.remove(),t.closest("li").remove()}catch(e){console.error("清空本地紀錄失敗:",e)}}))}if(r.length>0){const e=$("<li><strong>熱門關鍵字</strong><ul></ul></li>");r.forEach((t=>{const a=$(`<li><a href="#" title="搜尋：${t.key}">${t.key}</a></li>`);e.find("ul").append(a)})),a.append(e)}a.removeClass("d-none"),$(".search-category .input-container").addClass("suggestions")}else a.addClass("d-none"),$(".search-category .input-container").removeClass("suggestions")})),$(document).on("click",".delete-local",(async function(t){t.preventDefault();const a=$(this).siblings("a").text();try{await e.deleteData(a),$(this).closest("li").remove(),i=await e.getData()}catch(e){console.error("刪除本機資料時發生錯誤:",e)}})),$(document).on("click",".search-suggestions a",(function(e){e.preventDefault();const t=$(this).text();$(".search-input").val(t),$(".search-input").trigger("change"),$(".search-suggestions").addClass("d-none"),$(".search-category .input-container").removeClass("suggestions")}));function n(e){const t=$(".search-suggestions a"),a=$(".search-suggestions");if(e<0||e>=t.length)return;t.removeClass("highlighted");const n=t.eq(e);n.addClass("highlighted");const i=n[0].offsetTop,r=n.outerHeight(),o=(a.scrollTop(),i-a.innerHeight()/2+r/2);a.scrollTop(o)}$(".search-input").on("keydown",(function(e){const t=$(".search-suggestions a");if(!t.length)return;const a=t.filter(".highlighted");let i=t.index(a);switch(e.key){case"ArrowDown":e.preventDefault(),n((i+1)%t.length);break;case"ArrowUp":e.preventDefault(),n((i-1+t.length)%t.length);break;case"Enter":const a=$(".search-suggestions a.highlighted");if("Enter"===e.key&&a.length>0)return e.preventDefault(),void a.trigger("click");"Enter"===e.key&&$(this).trigger("change");case"Tab":i>=0&&t.eq(i).focus()}}))}catch(r){console.error("取得資料時發生錯誤:",r)}})(),e.on("click",(function(){window.location.href=`/${OrgName}/Search/Get/${$(this).data("id")}/${t.data("search-text")}`})),$(".search-category .catalog_frame [name='startDate']").on("change",(function(){t.data("startDate",$(this).val())})),$(".search-category .catalog_frame [name='endDate']").on("change",(function(){t.data("endDate",$(this).val())})),$(".search-category .catalog_frame").on("load",(function(){const e=$(this),t=$("#filterTemp").html(),a=$("#filterList"),n=$(this).data("filter"),i=$("#filterDirTypeTemp").html(),o=$("#filterBlock > .filterDirType > ul");a.empty(),o.empty(),e.data("directoryType").unshift({id:0,name:"全部"}),$("#filterBlock .fa-close").on("click",(function(){$("#filterBlock").removeClass("active"),$("body").removeClass("modal-open")})),$(".btn_filter_grid").on("click",(function(){$("#filterBlock").addClass("active"),$("body").addClass("modal-open")})),$(e.data("directoryType")).each(((t,a)=>{const n=$(i);void 0!==e.data("directoryTypeChecked")&&e.data("directoryTypeChecked")==a.id&&$("#filterBlock > .filterDirType > a").text(a.name),n.find("a").data(a).text(a.name).on("click",(function(){return e.data("directoryTypeChecked",$(this).data("id")),$("#filterBlock > .filterDirType > a").text($(this).data("name")),e.trigger("filter"),!1})),o.append(n)})),$(n).each(((n,i)=>{const o=$(t),c=`filterType${i.type}-${i.id}`,s=o.find("ul"),l=s.html();s.empty();const d=o.find(".filterType>.form-check-input").data("type",i.type).attr("id",c).on("change",(function(){const e=$(this);e.prop("checked")?e.parents("li").find("li .form-check-input").prop("checked",!0).trigger("change"):e.parents("li").find("li .form-check-input").prop("checked",!1).trigger("change")}));if(o.find(".filterType>label").attr("for",c),$(i.tags).each(((t,a)=>{const n=$(l),o=`filterTag${i.type}-${a.fK_TId}`;if(a.count<=0)return;const c=n.children(".form-check-input").data({type:i.type,gid:i.id,id:a.fK_TId}).attr("id",o).on("change",(function(){const t=$(this);clearTimeout(r),void 0===e.data("filtered")&&e.data("filtered",[]),t.prop("checked")?filteredPush(e.data("filtered"),t.data()):filteredPop(e.data("filtered"),t.data()),r=setTimeout((function(){e.trigger("filter")}),1e3)}));if(n.children("label").attr("for",o),n.find(".tagName").text(a.tag_Name),n.find(".count").text(a.count),s.append(n),void 0!==e.data("filtered")){const t=e.data("filtered").filter((e=>e.type==i.type));if(0!=t.length){const e=t[0].group.filter((e=>e.id==i.id));0!=e.length&&e[0].tags.includes(a.fK_TId)&&c.prop("checked",!0).trigger("change")}}})),void 0!==e.data("filtered")){const t=e.data("filtered").filter((e=>e.type==i.type));if(0!=t.length){const e=t[0].group.filter((e=>e.id==i.id));0!=e.length&&e[0].tags.length==i.tags.filter((e=>e.count>0)).length&&d.prop("checked",!0).trigger("change")}}o.find(".typeName").text(i.name),s.children("li").length>0&&a.append(o)})),"3"!=$(".search-category .active").data("id")||""==$(".searchText").text().trim()?$("#filterBlock").addClass("d-none"):$("#filterBlock").removeClass("d-none"),clearTimeout(r)})),$(".searchbtn").on("click",(function(){window.location.href=`/${OrgName}/Search/Get/${t.data("dirid")}/${t.data("search-text")}`}))}function filteredPush(e,t){filteredInsertOrDeleted(e,t,!0)}function filteredPop(e,t){filteredInsertOrDeleted(e,t,!1)}function filteredInsertOrDeleted(e,t,a){const n=e.filter((e=>e.type==t.type));let i=null;0==n.length?(i={type:t.type,group:[]},e.push(i)):i=n[0];const r=i.group.filter((e=>e.id==t.gid));if(0==r.length)i.group.push({id:t.gid,tags:[t.id]});else{const e=r[0].tags;e.includes(t.id)?a||e.splice(e.indexOf(t.id),1):a&&e.push(t.id)}}